<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="somewhere to talk about ideas and projects and stuff like everyone else">
    <link rel="stylesheet" href="/style/main.css">
  </head>
  <body>
    <div class="whitebox">
      <div class="graybar top">
        <header class="top">
          <div class="slogan">somewhere to talk about random ideas and projects like everyone else</div><a href="/">
            <h1 class="logo">
              stuff
               <span class="byline">by antimatter15</span>
            </h1></a>
        </header>
      </div>
      <div id="main">
        <div class="sidebar">
          <div class="about">
            <p class="emph">
              Hi. I’m <b>Kevin Kwok</b>, and I’m currently a sophomore at <b>MIT</b>, 
              and this is my obligatory online presence or whatever.  
            </p>
            <p>
              I regularly updated this site from 2007, when I started it in elementary school, 
              to summer 2014, when it was unwittingly absorbed into an international phishing ring.
            </p>
            <p>
              But like a phoenix, hydra or the national deficit, the site is back 
              again bigger than ever (after a rather long gestation period).
            </p>
            <p>
              For more obnoxious autobiographical content 
              blended with bits of nostalgia for the old PHP-on-sketchy-free-webhosting days, click here.
            </p>
          </div><br>
          <section class="archive"><a href="/archive">
              <h2>Archive</h2></a>
            <ul>
              <li>
                <ul>
                  <li><a href="/2015/04"><span class="month">April</span> <span class="year">2015</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2014/05"><span class="month">May</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/04"><span class="month">April</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/03"><span class="month">March</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/02"><span class="month">February</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/01"><span class="month">January</span> <span class="year">2014</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2013/12"><span class="month">December</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/11"><span class="month">November</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/10"><span class="month">October</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/09"><span class="month">September</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/08"><span class="month">August</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/07"><span class="month">July</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/06"><span class="month">June</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/05"><span class="month">May</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/04"><span class="month">April</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/03"><span class="month">March</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/02"><span class="month">February</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/01"><span class="month">January</span> <span class="year">2013</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2012/12"><span class="month">December</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/11"><span class="month">November</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/10"><span class="month">October</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/09"><span class="month">September</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/08"><span class="month">August</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/07"><span class="month">July</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/06"><span class="month">June</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/05"><span class="month">May</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/04"><span class="month">April</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/03"><span class="month">March</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/02"><span class="month">February</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/01"><span class="month">January</span> <span class="year">2012</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2011/12"><span class="month">December</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/11"><span class="month">November</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/10"><span class="month">October</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/09"><span class="month">September</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/08"><span class="month">August</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/07"><span class="month">July</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/06"><span class="month">June</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/05"><span class="month">May</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/04"><span class="month">April</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/03"><span class="month">March</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/02"><span class="month">February</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/01"><span class="month">January</span> <span class="year">2011</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2010/12"><span class="month">December</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/11"><span class="month">November</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/10"><span class="month">October</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/09"><span class="month">September</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/08"><span class="month">August</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/07"><span class="month">July</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/06"><span class="month">June</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/05"><span class="month">May</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/04"><span class="month">April</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/03"><span class="month">March</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/02"><span class="month">February</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/01"><span class="month">January</span> <span class="year">2010</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2009/12"><span class="month">December</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/11"><span class="month">November</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/10"><span class="month">October</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/09"><span class="month">September</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/08"><span class="month">August</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/07"><span class="month">July</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/06"><span class="month">June</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/05"><span class="month">May</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/04"><span class="month">April</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/03"><span class="month">March</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/01"><span class="month">January</span> <span class="year">2009</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2008/12"><span class="month">December</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/11"><span class="month">November</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/10"><span class="month">October</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/09"><span class="month">September</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/08"><span class="month">August</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/07"><span class="month">July</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/06"><span class="month">June</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/05"><span class="month">May</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/04"><span class="month">April</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/01"><span class="month">January</span> <span class="year">2008</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2007/12"><span class="month">December</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/11"><span class="month">November</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/10"><span class="month">October</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/09"><span class="month">September</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/08"><span class="month">August</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/05"><span class="month">May</span> <span class="year">2007</span></a></li>
                </ul><br>
              </li>
            </ul>
          </section>
          <div class="tags">
            <h2>Tags</h2><a href="/tag/3D" style="font-size: 15px">3D </a><a href="/tag/ajax" style="font-size: 19.998766054240136px">ajax </a><a href="/tag/ajax animator" style="font-size: 19.99983298578152px">ajax animator </a><a href="/tag/api" style="font-size: 15px">api </a><a href="/tag/apple" style="font-size: 19.93307149075715px">apple </a><a href="/tag/art" style="font-size: 12.689414213699951px">art </a><a href="/tag/awesome" style="font-size: 15px">awesome </a><a href="/tag/blog" style="font-size: 17.31058578630005px">blog </a><a href="/tag/browser" style="font-size: 19.93307149075715px">browser </a><a href="/tag/bugfix" style="font-size: 17.31058578630005px">bugfix </a><a href="/tag/canvas" style="font-size: 15px">canvas </a><a href="/tag/change" style="font-size: 17.31058578630005px">change </a><a href="/tag/chrome" style="font-size: 19.999999998973813px">chrome </a><a href="/tag/chrome extension" style="font-size: 12.689414213699951px">chrome extension </a><a href="/tag/chrome os" style="font-size: 12.689414213699951px">chrome os </a><a href="/tag/chromebook" style="font-size: 12.689414213699951px">chromebook </a><a href="/tag/code" style="font-size: 15px">code </a><a href="/tag/color" style="font-size: 12.689414213699951px">color </a><a href="/tag/colors" style="font-size: 12.689414213699951px">colors </a><a href="/tag/css" style="font-size: 12.689414213699951px">css </a><a href="/tag/demo" style="font-size: 12.689414213699951px">demo </a><a href="/tag/design" style="font-size: 18.807970779778824px">design </a><a href="/tag/elitist" style="font-size: 19.820137900379084px">elitist </a><a href="/tag/evil" style="font-size: 19.52574126822433px">evil </a><a href="/tag/experiment" style="font-size: 15px">experiment </a><a href="/tag/export" style="font-size: 12.689414213699951px">export </a><a href="/tag/extension" style="font-size: 19.820137900379084px">extension </a><a href="/tag/ExtJS" style="font-size: 19.820137900379084px">ExtJS </a><a href="/tag/facebook" style="font-size: 12.689414213699951px">facebook </a><a href="/tag/fast" style="font-size: 19.820137900379084px">fast </a><a href="/tag/features" style="font-size: 17.31058578630005px">features </a><a href="/tag/firefox" style="font-size: 19.975273768433652px">firefox </a><a href="/tag/flash" style="font-size: 18.807970779778824px">flash </a><a href="/tag/free" style="font-size: 12.689414213699951px">free </a><a href="/tag/function" style="font-size: 15px">function </a><a href="/tag/future" style="font-size: 17.31058578630005px">future </a><a href="/tag/GAE" style="font-size: 15px">GAE </a><a href="/tag/github" style="font-size: 17.31058578630005px">github </a><a href="/tag/google" style="font-size: 19.999999999999872px">google </a><a href="/tag/google code" style="font-size: 12.689414213699951px">google code </a><a href="/tag/google wave" style="font-size: 19.998766054240136px">google wave </a><a href="/tag/graphics" style="font-size: 15px">graphics </a><a href="/tag/hacking" style="font-size: 12.689414213699951px">hacking </a><a href="/tag/hosting" style="font-size: 19.52574126822433px">hosting </a><a href="/tag/html5" style="font-size: 19.52574126822433px">html5 </a><a href="/tag/idea" style="font-size: 15px">idea </a><a href="/tag/images" style="font-size: 12.689414213699951px">images </a><a href="/tag/internet exploder" style="font-size: 19.820137900379084px">internet exploder </a><a href="/tag/ipad" style="font-size: 18.807970779778824px">ipad </a><a href="/tag/javascript" style="font-size: 19.99999999721053px">javascript </a><a href="/tag/json" style="font-size: 17.31058578630005px">json </a><a href="/tag/library" style="font-size: 12.689414213699951px">library </a><a href="/tag/light" style="font-size: 12.689414213699951px">light </a><a href="/tag/lines" style="font-size: 15px">lines </a><a href="/tag/linux" style="font-size: 18.807970779778824px">linux </a><a href="/tag/login" style="font-size: 17.31058578630005px">login </a><a href="/tag/mac" style="font-size: 12.689414213699951px">mac </a><a href="/tag/magical" style="font-size: 17.31058578630005px">magical </a><a href="/tag/math" style="font-size: 12.689414213699951px">math </a><a href="/tag/meta" style="font-size: 12.689414213699951px">meta </a><a href="/tag/microsoft" style="font-size: 15px">microsoft </a><a href="/tag/microwave" style="font-size: 17.31058578630005px">microwave </a><a href="/tag/mirror" style="font-size: 12.689414213699951px">mirror </a><a href="/tag/multitouch" style="font-size: 15px">multitouch </a><a href="/tag/new" style="font-size: 19.52574126822433px">new </a><a href="/tag/nostalgia" style="font-size: 12.689414213699951px">nostalgia </a><a href="/tag/ocr" style="font-size: 12.689414213699951px">ocr </a><a href="/tag/offline" style="font-size: 18.807970779778824px">offline </a><a href="/tag/old" style="font-size: 18.807970779778824px">old </a><a href="/tag/onlypaths" style="font-size: 18.807970779778824px">onlypaths </a><a href="/tag/pi" style="font-size: 19.52574126822433px">pi </a><a href="/tag/processing" style="font-size: 12.689414213699951px">processing </a><a href="/tag/prototype" style="font-size: 15px">prototype </a><a href="/tag/python" style="font-size: 19.93307149075715px">python </a><a href="/tag/raphael" style="font-size: 19.52574126822433px">raphael </a><a href="/tag/release" style="font-size: 15px">release </a><a href="/tag/rewrite" style="font-size: 15px">rewrite </a><a href="/tag/security" style="font-size: 15px">security </a><a href="/tag/shiny" style="font-size: 19.975273768433652px">shiny </a><a href="/tag/ShinyTouch" style="font-size: 15px">ShinyTouch </a><a href="/tag/site" style="font-size: 15px">site </a><a href="/tag/small" style="font-size: 19.52574126822433px">small </a><a href="/tag/spam" style="font-size: 12.689414213699951px">spam </a><a href="/tag/speed" style="font-size: 12.689414213699951px">speed </a><a href="/tag/SVG" style="font-size: 17.31058578630005px">SVG </a><a href="/tag/touch" style="font-size: 15px">touch </a><a href="/tag/update" style="font-size: 19.999999943972036px">update </a><a href="/tag/upload" style="font-size: 18.807970779778824px">upload </a><a href="/tag/user interface" style="font-size: 12.689414213699951px">user interface </a><a href="/tag/vector" style="font-size: 15px">vector </a><a href="/tag/vectoreditor" style="font-size: 19.52574126822433px">vectoreditor </a><a href="/tag/version" style="font-size: 15px">version </a><a href="/tag/video" style="font-size: 17.31058578630005px">video </a><a href="/tag/vp8" style="font-size: 12.689414213699951px">vp8 </a><a href="/tag/vX JS" style="font-size: 19.52574126822433px">vX JS </a><a href="/tag/wave" style="font-size: 19.99999694097773px">wave </a><a href="/tag/webcam" style="font-size: 12.689414213699951px">webcam </a><a href="/tag/wikify" style="font-size: 19.820137900379084px">wikify </a><a href="/tag/wikipedia" style="font-size: 18.807970779778824px">wikipedia </a><a href="/tag/wordpress" style="font-size: 19.820137900379084px">wordpress </a>
          </div>
        </div>
        <div id="content">
          <h1>#super duper insanely long</h1>
          <article class="article intro">
            <header>
              <h2><a href="/2011/05/musicalpha-upload-to-google-music-beta-from-linux-and-chrome-os/">MusicAlpha Upload to Google Music Beta from Linux and Chrome OS</a> <span class="subtitle">14 May 2011</span></h2>
            </header>
            <section class="content"><p><em><strong>Rather pleasant update:</strong> This app works again. After some <a href="/2011/05/musicalpha-upload-to-google-music-beta-from-linux-and-chrome-os/2012/02/musicalpha-v2-0/%20‎">epic hackery</a>, it now works again.  <a href="https://chrome.google.com/webstore/detail/obojocfchdgdpgcigcdhdnlakfcbbgfn">Install it</a> now, in its fully functional, redesigned&nbsp;glory.</em></p>
<hr>
<p><em><strong>Rather depressing update:</strong> This sadly no longer works. It was fun and somewhat useful while it lasted. I have no idea why it doesn’t work, and I would really appreciate if someone could find out why it fails. However, it would be a good idea to <a href="https://chrome.google.com/webstore/detail/obojocfchdgdpgcigcdhdnlakfcbbgfn">install it anyway</a> and I&nbsp;guess.</em></p>
<hr>
<p><a href="/articles/2011/MusicAlpha%20Upload%20to%20Google%20Music%20Beta%20from%20Linux%20and%20Chrome%20OS/Screenshot.png"><img src="/articles/2011/MusicAlpha%20Upload%20to%20Google%20Music%20Beta%20from%20Linux%20and%20Chrome%20OS/Screenshot-300x195.png" alt="" title="Screenshot"></a></p>
<p>&nbsp;</p>
<p>Google Music Beta is a pretty cool web app, but the Music Manager sadly only works on Windows and Mac. As a Linux user who unfortunately feels neglected by the service, but still appreciative of being invited to the service a mere day after it’s announcement, I decided to do something to remedy the situation. Not to mention the irony that one can’t even upload music to the service from Google’s own Chrome <span class="caps">OS</span>. So <a href="https://chrome.google.com/webstore/detail/obojocfchdgdpgcigcdhdnlakfcbbgfn">MusicAlpha</a> was&nbsp;born.</p>
<p>This project was a pretty interesting hack, so I guess I’ll try to document the process of how I made it and how it currently works. And also, for any prospective filmmakers, this story might make for an interesting abstract action movie. But for any of you who just want to install the app, <a href="https://chrome.google.com/webstore/detail/obojocfchdgdpgcigcdhdnlakfcbbgfn">click here</a>.</p>
<h2 id="inception">Inception</h2>
<p>I started this only days after finishing the new revision of Cloud Save, the extension that I never quite understood, but everyone else seemed to get. One part of the newest revision was adding support for Amazon’s Cloud Drive service, which does not have an established <span class="caps">API</span>. However, the interactions between the javascript web interface and the server are pretty simple to understand, thanks to the almighty web inspector. The only weird thing was that the actual file upload was actually conducted through Flash, which felt unnecessary but it wasn’t an insurmountable task. But it was all built on carefully learning the way of the web&nbsp;client.</p>
<p>There was one feature request for Cloud Save to enable saving to Google Music, and that’s when the idea sort of&nbsp;started.</p>
<p>The first step was to get a Google Music account, nothing surprising there. A few hours after the announcement was the first opportunity for me to access a computer, and also when I hit the “request invite” button. In a shockingly short amount of time of a mere day, I received a nice email saying that I had been invited to the service. Yay. Now the letdown of not being able to upload from Linux begins, as well as the scheming to reverse engineer&nbsp;it.</p>
<p>A few months ago, I had the idea to do something similar, but with another Google product: Google Goggles. But after hooking up the anrdoid simulator with a http proxy (Charles), and looking at the results. I was rather dismayed, but not particularly surprised by the results: all the communication was encoded using Protobuf. Protobuf, or Protocol Buffers is “Google’s data interchange format”, according to it’s Google Code project page. It’s a structured system for encoding binary data where a .proto template is already known and compiled. Protobufs are bad in much the same way minification is. There are totally justifiable reasons to minify source code, but the elimination of a useful View Source detracts from the open ideal of the web. Though protocol buffers aren’t encrypted, they are not comprehensible without a .proto file to decode them. With a lot of work, one might be able to reverse engineer a .proto file, but it’s certainly much harder than a <span class="caps">JSON</span>&nbsp;protocol.</p>
<p>Before I began, this was the worst fear. That everything as encoded with protocol buffers, and my attempts to mimic it would be rendered&nbsp;futile.</p>
<h2 id="packets">Packets</h2>
<p>I borrowed a computer which ran Windows 7, and installed the Music Manager in hopes of deciphering the secret enigma of the great google. I needed a simple packet sniffer, and so I used nirsoft’s smartsniff. I didn’t use wireshark because it wasn’t my computer, and I didn’t want to install and download a huge app with an intimidating user interface. Smartsniff worked pretty well, and I thought I was almost there. Packet sniffers generally can’t decode https data without some <span class="caps">MITM</span>-esque certificate faking, and I have reason to believe that that wouldn’t work either since running the strings command on the MusicManager.exe file includes something that resembles a public&nbsp;key.</p>
<p>Anyway, I found two raw unencrypted <span class="caps">HTTP</span> requests, and sort of fixated myself on those&nbsp;two.</p>
<blockquote>
<p><span class="caps">POST</span> /uploadsj/rupio&nbsp;HTTP/1.1</p>
<p>User-Agent: Music Manager (1, 0, 12, 3443 -&nbsp;Windows)</p>
<p>Host:&nbsp;uploadsj.clients.google.com</p>
<p>Accept: <em>/</em></p>
<p>Cookie: <span class="caps">SID</span>=[redacted] domain=.google.com&nbsp;path=/</p>
<p>Expect:&nbsp;None</p>
<p>Content-Length:&nbsp;851</p>
<p>Content-Type:&nbsp;application/x-www-form-urlencoded</p>
<p>{“clientId”:”Jumper&nbsp;Uploader”,”createSessionRequest”:{“fields”:[{“inlined”:{“content”:”jumper-uploader-title-19Redacted”,”contentType”:”text/plain”,”name”:”title”}},</p>
<p>{“external”:{“filename”:”Redacted.mp3”,”name”:”C:\Users\Redacted.mp3”,”put”:{},”size”:610Redacted}},</p>
<p>{“inlined”:{“content”:”0”,”name”:”AlbumArtLength”}},</p>
<p>{“inlined”:{“content”:”0”,”name”:”AlbumArtStart”}},</p>
<p>{“inlined”:{“content”:”3rBe9dCa%c2tBeJdD”,”name”:”ClientId”}},</p>
<p>{“inlined”:{“content”:”00:1F:R3:<span class="caps">DA</span>:C7:ED”,”name”:”MachineIdentifier”}},</p>
<p>{“inlined”:{“content”:”5a5de21sd-54dsfe-Redacted”,”name”:”ServerId”}},</p>
<p>{“inlined”:{“content”:”true”,”name”:”SyncNow”}},</p>
<p>{“inlined”:{“content”:”153”,”name”:”TrackBitRate”}},</p>
<p>{“inlined”:{“content”:”false”,”name”:”TrackDoNotRematch”}}</p>
<p>]},”protocolVersion”:”0.8”}
I noticed the second request was rather huge, <span class="caps">3556KB</span>. Just enough to fit a normal-sized MP3. I knew what was in there.
PUT /uploadsj/rupio?upload_id=REDACTED&amp;file_id=000&nbsp;HTTP/1.1</p>
<p>User-Agent: Music Manager (1, 0, 12, 3443 -&nbsp;Windows)</p>
<p>Host:&nbsp;uploadsj.clients.google.com</p>
<p>Accept: <em>/</em></p>
<p>Cookie: <span class="caps">SID</span>=REDACTED domain=.google.com&nbsp;path=/</p>
<p>Content-Type:&nbsp;audio/mpeg</p>
<p>Expect:&nbsp;None</p>
<p>Content-Length:&nbsp;<span class="caps">3141REDACTED</span></p>
<p><span class="caps">ID3</span>…..%vTENC….@..WXXX……..TIT2……. Redacted
At this point, I was relatively ecstatic. Or at least, I will pretend that I was, because everything looked elegantly and remarkably simple. I had no idea where the upload_id came from, but I figured that it was part of the response from the first POST request. Part of the problem was that SmartSniff didn’t give me the actual responses to the HTTP requests, only the request data. Or at least from the five minutes that I bothered using it. The cookie looked like a generic cookie that would exist in a normal browser&nbsp;session.</p>
</blockquote>
<h2 id="prototype">Prototype</h2>
<p>Since it used generic browser cookies, the simplest way to start would be to make a browser extension. Specifically, a Chrome App. That way, I could get the necessary permissions to do all the cross domain security protocol violations and probe around a bunch of requests. Since XHRs already include cookies for a specific domain, there’s nothing I need to do to set the cookies. I hoped and suspected that the User-Agent, Accept, and Expect headers were basically ignored, and the content-type would be rather trivial to&nbsp;set.</p>
<p>A lesson in premature optimization was the huge block of <span class="caps">JSON</span> which got sent with the first POST request. I had no idea what was really essential, so basically, I just deleted almost everything there except for what I thought might be really important: the file name and size. There were no errors in the POST request, so I figured it was okay to delete all of that stuff. I ran the POST and just as I suspected, the JSON that resulted included the upload_id, in fact, it included the entire PUT url, which was pretty&nbsp;nice.</p>
<blockquote>
<p>{“sessionStatus”:{“state”:”<span class="caps">OPEN</span>”,”externalFieldTransfers”:[{“name”:”REDACTED.mp3”,”status”:”IN_PROGRESS”,”bytesTransferred”:0,”bytesTotal”:314REDACTED,”putInfo”:{“url”:”<a href="http://uploadsj.clients.google.com/uploadsj/rupio?upload_id=AEdREDACTED&amp;file_id=000&quot;},&quot;content_type&quot;:&quot;audio/mpeg&quot;}],&quot;upload_id&quot;:&quot;AEdREDACTED&quot;}}">http://uploadsj.clients.google.com/uploadsj/rupio?upload_id=AEdREDACTED&amp;file_id=000&quot;},&quot;content_type&quot;:&quot;audio/mpeg&quot;}],&quot;upload_id&quot;:&quot;AEdREDACTED&quot;}}</a>
Then, when I executed the subsequent <span class="caps">PUT</span> request. I was scared.
{“errorMessage”:{“reason”:”REQUEST_REJECTED”,”additionalInfo”:{“uploader_service.GoogleRupioAdditionalInfo”:{“completionInfo”:{“status”:”REJECTED”,”customerSpecificInfo”:{“ResponseCode”:404}},”requestRejectedInfo”:{“reasonDescription”:”agent_rejected”}}},”upload_id”:”AEdREDACTED”}}
Scary. The rejection reason was “agent_rejected”, which made me think about the User-Agent header, and I wondered if that was supposed to matter. If that did matter, then I would have to prototype it in a different language since XMLHttpRequests forbid the setting of the User-Agent and other headers for security reasons (even operating in a privledged&nbsp;environment!).</p>
</blockquote>
<p>But thankfully, before attempting the drastic route, I pasted back in the alleged cruft, the jumper-uploader-title, TrackDoNotRematch, TrackBitRate, SyncNow, ServerId, MachineIdentifier, ClientID, AlbumArtStart (hey that rhymes!), and AlbumArtLength. Magically now, it worked.&nbsp;Yay.</p>
<h2 id="rupio">Rupio</h2>
<p>During my quest to understand the bizarre agent_rejected error (because I totally fear rejection, they should have used a nicer word), I tried googling GoogleRupioAdditionalInfo. (I had googled “Rupio” before, since that was part of the <span class="caps">POST</span> url, but that didn’t yield any relevant results, it just ended up being a bunch of people’s names). Searching GoogleRupioAdditionalInfo yielded a more limited subset which happened to be more&nbsp;interesting.</p>
<p>The first result, from the SMEStorage Blog described an error emitted by the Google Docs platform. The next result was on the Picasa help forums, about “Upload video results in Error”. Then was a french language forum which mentioned an error which included GoogleRupioAdditionalInfo, this time on the url&nbsp;“upload.youtube.com”.</p>
<p>So, it seems “Rupio” is the codename (or just the name, but it’s much more fun imagining that there are subliminal codes everywhere) of a unified Google data upload/storage platform. That’s pretty cool. It probably makes sense that they have a sort of unified file storage system across Google Docs, Picasa, and Youtube, since it would probably be easier to maintain a system which is internally consistent. But to inject a sensationalist twist where occam’s razor shows that it’s not justified, this is a hint at an upcoming unified Google file storage service. A sort of file-browser dashboard which links all media and document files together in an accessible and uniform&nbsp;manner.</p>
<h2 id="shiny">Shiny</h2>
<p>It worked. Or at least, it seemed to work. Vaguely. At this point, I was reasonably satisfied and began sculpting a nice pretty interface for it. Following my usual way, I just stole the Tango icon for an audio file mime type and built the entire interface around it. I remembered that earlier that day, I had discovered something called Layer Styles, which is a photoshop gradient/style clone that instead generates <span class="caps">CSS3</span> gradients. I thought that was cool and I remembered it, so I played around with it and made a centered rectangle. Gray on&nbsp;Gray.</p>
<p>I decided on a name for it: MusicAlpha. It’s a sort of play on how this Google product features Beta in a way which is much more prominently than usual, with the gray “beta” the same size as the actual “music”. The Alpha sort of says something about how it will almost eternally be stuck in this unstable and incomplete form. It also reminded me of one of my favorite websites: wolfram alpha, and how the logo is stylized WolframAlpha or&nbsp;Wolfram|Alpha.</p>
<p>I wanted it to be minimal, but I’ve since adopted the belief that drag-and-drop file selection was only a fad. Sure, it’s often really useful, but it’s not great to restrict to that. A hybrid approach is much better, and if you have to have only one, then the standard browse button is better since you can drag and drop files to that button (on chrome, anyway) without any special code. Drag and Drop is often quite terrible on laptops, and I’m not sure if you can even drag and drop files with Chrome <span class="caps">OS</span>, since the file browser might be&nbsp;modal.</p>
<p>There’s not much to the interface, it’s probably as minimal as it can get. Two links, one to the service, the other to me. A button. That’s&nbsp;it.</p>
<h2 id="dismay">Dismay</h2>
<p>At some point in every good story (not implying that this is a good story), there’s false hope, where the protagonist (not implying that I’m the protagonist here, either) believes that he or she (not implying that I’m a she) is closer to the end than is factually warranted (I’m actually implying that that’s exactly what happened). I checked the Google Music song list, and lo and behold, the song was&nbsp;there.</p>
<p>Sort of. Not really.<em> Something</em> was. Not sure it was a&nbsp;song.</p>
<p><a href="/articles/2011/MusicAlpha%20Upload%20to%20Google%20Music%20Beta%20from%20Linux%20and%20Chrome%20OS/Screenshot1.png"><img src="/articles/2011/MusicAlpha%20Upload%20to%20Google%20Music%20Beta%20from%20Linux%20and%20Chrome%20OS/Screenshot1-300x60.png" alt="" title="Screenshot"></a></p>
<p>There was a blank row. Double click it, and something does play. And it is the song. But, there’s no way to seek because incidentally, it doesn’t know how long the track is, so there’s no way to render the position of the&nbsp;song.</p>
<p>It was late, and this was frustrating, so I just posted a terse blog post announcing the beginning of the&nbsp;project:</p>
<blockquote>
<p>So pretty soon, I hacked together something that almost sort of worked, with one rather significant caveat: It doesn’t pick up any tag data, name, time, artist, album, etc. I can’t figure out why. I guess I’ll try some more tomorrow.
And by the way, I totally lied. I didn’t try at all the next&nbsp;day.</p>
</blockquote>
<p>Yesterday, that is, May 13th, the delightful Friday the Thirteenth, I tried again. I installed Music Manager on a VMWare installation of Windows <span class="caps">XP</span>, and sniffed the traffic with Wireshark running on the host computer. Didn’t notice anything new in the plethora of data which happened to get exchanged. I tried running smartsniff from the VM, but every time I tried to start sniffing, VMWare magically&nbsp;crashed.</p>
<h2 id="skyjam">SkyJam</h2>
<p>At this point, I thought of looking at the MusicManager.exe binary. Usually, binaries have some random strings in them, which you can look at to give some hint at what it does, without actually decompiling something. I’m now going to proceed to anachronistically mention something about android, because of a certain <span class="caps">URL</span> that I find out later in this chronology: android.clients.google.com. So I used strings MusicManager.exe | grep android, and found some rather interesting&nbsp;things</p>
<blockquote>
<p>2-.wireless_android_skyjam.CopyrightStatus.Type</p>
<p>2”.wireless_android_skyjam.ProductId</p>
<p>wireless_android_skyjam.Uits</p>
<p>Metadata.ParentalAdvisoryType
There appears to be 214 mentions of the phrase “skyjam” in the executable, which I assume is not some new solar powered Google sandwich filling distribution mechanism powered by artificial intelligence driven aeronautically mobile condiment dispensers (obviously using&nbsp;Arduinos).</p>
</blockquote>
<p>I have no idea what Skyjam is, but that’s totally a much cooler name than Google Music, regardless of how big you write “beta”. And what’s wireless_android_skyjam? Why is skyjam so deeply tied with wireless and android? Maybe it’s got something to do with flying robot sandwich machines. Or&nbsp;not.</p>
<p>Maybe it has something to do with that Simplify Media company which Google bought last year. Or maybe I’m just a little sad that the product ended. According to&nbsp;TechCrunch,</p>
<blockquote>
<p>Google <span class="caps">VP</span> Vic Gundotra said that <a href="http://techcrunch.com/2010/05/20/um-did-google-just-quietly-launch-a-web-based-itunes-competitor-yep/#ixzz0oUJBJO3l">Simplify’s technology</a> will be used to offer a desktop app that will give you access to all of your (<span class="caps">DRM</span>-free) media on your Android devices remotely, using Google’s new iTunes competitor on the&nbsp;web.</p>
<p>&gt;
Desktop App: Check. Android: Check. New iTunes Competitor on the Web: Check. Simplify’s Technology: Not so&nbsp;much.</p>
</blockquote>
<p>For those who aren’t familiar with what Simplify did (which I assume is nigh everyone), it streamed your music by making your desktop into something of a server, so your huge cache of music can be accessible by any mobile device&nbsp;remotely.</p>
<h2 id="fishtank">Fishtank</h2>
<p>I had a random false lead. I thought that the server still read <span class="caps">ID3</span> data on itself, and noticed that the HTTP dump was somehow slightly different from the original file. It was the same length. The exact same length, but some of the bytes were different. Most were the same, and they were all in the same place, but for example, all 0x00’s seemed to have been swapped with 0xe4’s. Some other bytes were also different, and in retrospect this was probably because the program which created the http dump sucked and encoded all the bytes wrong or something. But I tried opening it up in Ghex and I swapped every 0xe4 with a 0x00, and magically the broken file now played, with one exception: the audio now sounded like a fishtank. It’s like everything’s just water, magestically moving around with exquisite&nbsp;sublimity.</p>
<h2 id="sniffing">Sniffing</h2>
<p>I borrowed another Windows computer this time, and tried again. This time, I also tried the <span class="caps">HTTP</span> Proxy called Fiddler, which seemed to be able to capture more information, or at least give me more of the information that I would find useful and less of what I wouldn’t find useful. I noticed that for every file which was uploaded, there were in fact three requests, not two as I had previously&nbsp;observed.</p>
<p>So where had this covert <span class="caps">HTTP</span> request been hiding? Behind in the magical realm of HTTPS/TLS encryption. I couldn’t peek into the actual content of the HTTPS requests because of the fact it was encrypted. And as the strings command had revealed earlier, there was a huge block of base64 encoded text which appeared to look like a sort of public key. It suddenly connected, the Music Manager probably has its own list of trusted certificate authorities, and that’s why adding a mere certificate to Windows wouldn’t do a&nbsp;thing.</p>
<p>But the unencrypted <span class="caps">CONNECT</span> request, which initiates a HTTPS connection said&nbsp;enough.</p>
<p>There was a request to android.clients.google.com and it was encoded with gasp: application/x-protobufs. If this was some sort of action movie, here would be the scene where the antagonist from the previous movie reveals that he is still alive (with some facial scarring) and the person responsible for all the disappearing bodies (of&nbsp;data).</p>
<p>I was about to give up at this point, but then a new idea&nbsp;sturck.</p>
<h2 id="a-new-hope">A New&nbsp;Hope</h2>
<p>This is the second movie-title article sub-title that I’m aware of, unless there’s a movie called “Packet Sniffing”. For the prospective filmmaker, this is when the protagonist has the flashback and remembers that time, long long ago (though here it’s only like four days, you can take creative liberties), when refining the art of hackery, a task involved crafting an implementation of a storage system from the web interface of a specific cloud drive&nbsp;service.</p>
<p>So, I noticed that I had spent so much time exploring what enigma lay beyond the surface of Google Music, that I totally forgot to actually use the service. And when I did, I realized that there was an Edit Song Info context button. Trying the feature out, it seems to be a simple <span class="caps">JSON</span> post to a certain modifyentries&nbsp;URL.</p>
<blockquote>
<div><span class="caps">POST</span> <a href="http://music.google.com/music/services/modifyentries?u=0&amp;xt=AM-REDACTED">http://music.google.com/music/services/modifyentries?u=0&amp;xt=<span class="caps">AM</span>-REDACTED</a></div>

<div>{“entries”:[{</div>

<div>“genre”:”<span class="caps">REDACTED</span>”,</div>

<div>“beatsPerMinute”:0,</div>

<div>“albumArtistNorm”:””,</div>

<div>“album”:”<span class="caps">REDACTED</span>”,</div>

<div>“artistNorm”:””,</div>

<div>“lastPlayed”:1305419744984200,</div>

<div>“durationMillis”:192168,</div>

<div>“url”:””,</div>

<div>“id”:”564ads4f8e4-<span class="caps">REDACTED</span>”,</div>

<div>“composer”:””,</div>

<div>“creationDate”:130541974874500,</div>

<div>“title”:”<span class="caps">REDACTED</span>”,</div>

<div>“albumArtist”:”<span class="caps">REDACTED</span>”,</div>

<div>“playCount”:0,</div>

<div>“name”:”<span class="caps">REDACTED</span>”,</div>

<div>“artist”:”<span class="caps">REDACTED</span>”,</div>

<div>“titleNorm”:””,</div>

<div>“rating”:0,</div>

<div>“comment”:”<span class="caps">REDACTED</span>”,</div>

<div>“albumNorm”:””,</div>

<div>“year”:”2004”,</div>

<div>“track”:”04”,</div>

<div>“totalTracks”:””,</div>

<div>“disc”:””,</div>

<div>“totalDiscs”:””</div>

<p><div>}]}</div>
Amazing. I just stumbled on the magical code which would allow me to finish the project. Yay. Now I had to figure out what the xt= parameter means (after determining it’s necessity). My first hunch was to search the <span class="caps">HTML</span> source of the page, because the magical access codes for Amazon Cloud Drive were put inside a hidden input element. But no, it wasn’t there. Now the fear starts settling in, what if it’s a strategically computed magical super string? But why would they ever do&nbsp;that?</p>
</blockquote>
<p>Somehow I noticed somewhere on every time the page is loaded, the network logs indicate a Set-Cookie: xt=<span class="caps">AM</span>-REDACTED. Now I knew how to get it: Just send an XHR to the cloud player and copy the&nbsp;cookie.</p>
<h2 id="serverid">ServerID</h2>
<p>Now, the important pat of all the items in the entries object is probably the id. Everything else seems somewhat generic, and probably exists for any song that you throw at the service, but id clearly has a definite, important, non-random, predetermined value. I thought that there was no correlation between the data passed from the uploaded data and the id which was here, since the upload_id was way too long and had nothing in common with this song&nbsp;id.</p>
<p>Since the songs that get uploaded have no title, they always appear first on the alphabetical list of songs, so I figured I would just pull a list of the songs, alphabetically, and then take the first one to get the <span class="caps">ID</span>. Then I discovered the auto-playlists, which included one for most recently&nbsp;added.</p>
<p>Unless you have the power of omniscience, you don’t know that the format of the IDs here were like das8f7-adf0w8f-adf87we-mwere, because I slapped a huge <span class="caps">REDACTED</span> on the latter half. The random string generating code that I’ve used for years out of convenience is Math.random().toString(36).substr(2), which basically generates a random float, converts the fractional part to base 36 (0-9 a-z) and strips the leading “0.” from the string. This incidentally ends up being quite short (especially on chrome, it’s much longer on firefox), and lacks the&nbsp;dashes.</p>
<p>So I looked at the <span class="caps">ID</span> for one of the streams and noticed that the id string was unusually short. I started wondering why something like that would happen, and then it struck me, not quite like lightning because I’m still alive (though whether or not I am when you’re reading this is a totally different question). This file ID was the same thing as the ServerID which I thought was just a random useless value that was arbitrarily required for it to work. I deleted the whole getRecent routine and suddenly everything started to make&nbsp;sense.</p>
<h2 id="fish">Fish</h2>
<p>You probably don’t remember my old blog post, almost a year ago, titled A Bright Coloured Fish: Parsing ID3v2 Tags in Javascript and ExtensionFM. Recently, by fate, I happen to have used that code more times that I’m comfortable with, and it seems that once again I must revive this old memory. It’s fairly outdated, and some things are very nasty. Not being able to parse ID3v1 is pretty terrible, though I don’t think I have any songs using&nbsp;v1.</p>
<p>I hoped that Google’s magical server farm would have parsed out the <span class="caps">ID3</span> data, but that doesn’t seem to be the case. I have to manually parse them in the&nbsp;client.</p>
<p>I had to change the id3v2 library a slight bit: the picture parsing code now includes a blob attribute, since the the album art must be uploaded to Google’s servers in order to be included in the&nbsp;metadata.</p>
<p>I guess that fishtank sound was an omen. I’m sure the prospective filmmaker could use it in some way like&nbsp;this.</p>
<h2 id="time">Time</h2>
<p>Rather auspiciously, the modifyentries command included durationMillis. Since it became evident that the music player app had no way of knowing the length of a song without some tag data, that it would be impossible to seek to a certain portion of the song without this ability, it was really important. But since this was from the <span class="caps">API</span> for a user-facing operation, and editing the length of a song isn’t something that a user can or should be able to edit, it was pretty fortunate that that was included as part of the&nbsp;API.</p>
<p>This wasn’t without problems though. It’s not that easy to measure the length of a song. The Length tag of a <span class="caps">MP3</span> file is actually seldom included, so that clearly can’t work. I looked at how to measure the length, and it was pretty scary, since it doesn’t seem like there’s any way other than parsing all the frames out and multiplying the&nbsp;bitrates.</p>
<p>But this time, <span class="caps">HTML5</span> comes to the rescue. I never thought I would be so happy to use . I just take the file, convert it to a blob URL through that nest of if/else statements that handles different versions of chrome. I open it with new Audio and wait for the metadata event, indicating that I now know the length of the song to thirteen places after the decimal. Because of course, I would hate to miss the last picosecond of my&nbsp;song.</p>
<p>I felt sad for the little femtoseconds and attoseconds who were neglected by Google when they decided that the song lengths should be milliseconds. Not quantized divisions of Planck&nbsp;time.</p>
<h2 id="epilogue">Epilogue</h2>
<p>At this point, nothing interesting really happened. I fixed up the interface, added queueing, and other insignificant things. I published it and spent the rest of day writing a hopelessly long document describing&nbsp;it.</p>
<h2 id="protocol">Protocol</h2>
<p>For those who want to build their own programs which upload to Google Music, I guess I’ll write a summary of how it&nbsp;works.</p>
<ol>
<li>Get Song Metadata (<span class="caps">ID3</span> data, Duration,&nbsp;primarily)</li>
<li>Login to&nbsp;Google</li>
<li><span class="caps">POST</span> to&nbsp;uploadsj.clients.google.com/uploadsj/rupio</li>
<li><span class="caps">PUT</span> to putUrl as part of the response of previous&nbsp;operation</li>
<li>Load music.google.com/music/listen and capture xt value from Set-Cookie response&nbsp;header</li>
<li>(Optional) Upload Album Art to&nbsp;music.google.com/music/services/imageupload?u=0&amp;xt=</li>
<li>Set file metadata via&nbsp;music.google.com/music/services/modifyentries?u=0&amp;xt=</li>
</ol>
<h2 id="friendly-reminder">Friendly&nbsp;Reminder</h2>
<p>To get the app described in this lengthy narrative, <a href="https://chrome.google.com/webstore/detail/obojocfchdgdpgcigcdhdnlakfcbbgfn">click here</a>.</p>

            </section>
          </article>
          <hr>
          <article class="article intro">
            <header>
              <h2><a href="/2010/06/deep-integration-wave-embed-api/">Deep Integration Wave Embed API</a> <span class="subtitle">30 June 2010</span></h2>
            </header>
            <section class="content"><p><a href="/articles/2010/Deep%20Integration%20Wave%20Embed%20API/Selection_076.png"><img src="/articles/2010/Deep%20Integration%20Wave%20Embed%20API/Selection_076.png" alt="" title="Can you tell that Wave is the backend? I think not."></a><a href="/articles/2010/Deep%20Integration%20Wave%20Embed%20API/Selection_078.png"><img src="/articles/2010/Deep%20Integration%20Wave%20Embed%20API/Selection_078.png" alt="" title="Just to prove that it"></a></p>
<p>Can you tell that the screenshot on the left is actually an embedded wave? Probably&nbsp;not.</p>
<p>First, a little overview on what this is. A lot of people are interested in using Google Wave as a commenting system, however the <strong>official embed api at the current state suffers from several shortfalls</strong>. It’s tedious to operate a wave-integrated commenting system. As an author, you have to <strong>manually create a wave for every post</strong>, copy the content over to the wave, get the wave <span class="caps">ID</span>, and paste it into your template. Every time you change your post, you have to yet again manually sync the page with wave. Once you’ve gotten the wave into the page, the embedded wave itself has a few issues. You <strong>can’t style it using <span class="caps">CSS</span></strong>, and you can only change the background color and font. The width can’t adjust to the width of your page after the initial load. There’s no way to get rid of or change the style of the<strong> huge blue border</strong> around it. It<strong> forces it’s own scroll bar</strong> which looks nothing like anything else on the page and <strong>prevents intuitive navigation</strong> of comments using the same scrollbar as the rest of the page. Lastly, there’s no way for anonymous readers to comment on the&nbsp;post.</p>
<p>For each of these issues,<strong> the new w2_embed api offers a solution</strong>. Instead of using iframes to hack another page onto the current one, this one is built into the page, injecting elements directly onto the page’s <span class="caps">DOM</span>. These<strong> elements can be styled in nearly any imaginable way through <span class="caps">CSS</span> and HTML</strong>. The sandboxed and namespaced single-function <span class="caps">API</span> allows for multiple waves on one page with less than 10KB of JS overhead (Compare to about 1.4 megabytes). Instead of relying on a special Wave ID, the app uses a centralized and remotely stored database which associates any identifier you provide with functional wave IDs. That means, that instead of using a string like <code>googlewave.com!w+Blsm0RMW_A</code>, you have the <span class="caps">URL</span> of your blog, say <code>2010/06/wave-embed-api</code>. Not only that, but it can <strong>automatically pull the title of your wave, the authors, the permalink and tags from the post, automatically create a wave from that with the same tags and title with the content automatically set as the root blip as well as a permalink back to the blog post</strong>. When viewed from wave, the user can follow, unfollow, search and find waves using the exact same familiar interface. On your blog, you can make the wave backend entirely seamless and subtle. Since it’s built on top of Anonybot<strong>, people can reply blips without having google wave</strong> accounts right from your&nbsp;blog.</p>
<p>It’s all part of a new embed <span class="caps">API</span> built upon Anony-bot (which itself is built upon microwave, which is built on wave reader, which is built upon the prototype python desktop client… Someone should make a wordpress plugin for this to make this family history even&nbsp;longer).</p>
<p>The<a href="/2010/06/deep-integration-wave-embed-api/2010/06/anony-bot-embed-api/"> last post noted the beginning of this project,</a> and here is part two. The <span class="caps">API</span> has been cleaned up a lot. The code has been simplified. Features added and design&nbsp;changed.</p>
<p>The major change is a total decoupling of it and the mainline Anonybot codebase. There are some major implications of the change. In the original prototype of the <span class="caps">API</span>, it still had the iconic blip context menu inherited from microwave. That’s gone. So is the participants bar, link to real wave client, blip html, blip content, reply box, and everything. There are now no required or automatically added html/dom elements. Everything is specified through a <strong>simple <span class="caps">HTML</span> templating engine</strong>. Since the code isn’t shared, changes from each individual project now on probably won’t be instantly applied to both. This has advantages and disadvantages. On the plus side, is that changes to anonybot won’t break the embed api. However, bug fixes on one may not propagate to the other.  The code can be much smaller since features like search, which was previously hidden, can now be totally removed. Also, since it’s been rewritten from scratch as an embed api, it no longer exposes any extra globals and multiple embeds can be done for each&nbsp;page.</p>
<p>The biggest change is the templating engine. Before, it only worked with the blip design, but now it’s totally integral to every aspect of the interface. Lets walk through the basics of the <span class="caps">API</span>, starting with a minimal&nbsp;example.</p>
<script type="text/javascript" src="http://gist.github.com/458802.js?file=w2_embed_demo.html"></script>All the content is wrapped in a huge hidden `div`, and inside is one element with the `wavebody` class. That huge wave is the scope of the templating engine. That means that if you put `{{1+1}}` anywhere inside the `div`, it&#8217;ll show up as 2&#46; Place it anywhere outside the div, and it shows up as `{{1+1}}`. Simple, right? The `wavebody` element is where the actual blips will go. But since there aren&#8217;t any blips beforehand, `wavebody` is filled with the template for a single blip. The content gets multiplied several times and that makes the wave. The template scheme is really simple. Basically, you just wrap arbitrary <span class="caps">JS</span> code within `{{` and `}}`. The code gets executed (in the scope of the wave) and the block gets replaced with the return value of the script. When you&#8217;re inside `wavebody` there are a few additional blip-specific things that you can add. Now we have to learn the magical snippets of code you can use inside the curly brackets. One of the objects exposed to the templates is `wave`. The nice thing is that it mirrors [the wave api](http://code.google.com/apis/wave/extensions/robots/protocol.html#Wavelets). So the wave object exposes the following attributes (copied from the google page).

*   `creationTime` denotes the [Unix time](http://en.wikipedia.org/wiki/Unix_time) at which this wavelet was created.
*   `creator` denotes the address of the participant who created this wavelet.
*   `lastModifiedTime` denotes the [Unix time](http://en.wikipedia.org/wiki/Unix_time) at which the wavelet was last modified by any participant.
*   `participants` contains an array of participant IDs for all participants on the wave.
*   `rootBlipId` contains the Blip ID of the root blip.
*   `title` contains the title of the wavelet, which by default consists of the first line of text up to the first carriage return.
*   `version` contains the version of this wavelet. Each atomic operation on a wavelet increases this version number.
*   `waveId` contains the Wave ID of this wavelet.
*   `waveletId` contains the wavelet ID of this wavelet. Note that for waves which contain only one wavelet (that don&#8217;t have private conversations, in other words), this wavelet ID is usually of the form `conv+root` indicating that the wavelet is identical to the conversation root, the root wave.
*   `dataDocuments` contains a dictionary (associated array) of the IDs and data of any data documents attached to this wavelet.

In addition, there are a few non-standard components.

*   `permalink` contains a link to the waveref which points to the specific wave on the real wave client
*   `blips` contains a js object (similar to a hash or dictionary) of blipIDs associated to blip objects
*   `bliparr` contains an array of blip ids in no particular order, most frequently used for getting the number of replies in a conversation in `{{wave.bliparr.length-1}}`

There are also some functions you can call. For example, `wave.creationTime` is in the form of a unix timestamp. That probably isn&#8217;t too useful to an ordinary user, so a `format_time` function is there to format it like &#8220;6/30 10:45am&#8221;. If you want to have some other custom datetime format, get me a script to do it in javascript in less than 500 bytes and I&#8217;ll include it in the next version.

*   `format_time(int)` Format a unix-style date as a human-readable &#8220;6/30 10:45am&#8221; or if you prefer &#8220;m/d h:MMtt&#8221;
*   `render(blip)` Render a blip and return the HTML. Most of the time, it&#8217;s unnecessary as there&#8217;s a blip.html attribute

There are a few actions that you can do. Certain strings like `{{addparticipant}}` can be used in `onclick=` attributes to trigger certain actions on various events.
<script type="text/javascript" src="http://gist.github.com/458944.js?file=events.w2_embed.html"></script>

<p>Here you see a link and a button. The link has been configured to prompt the user for a participant <span class="caps">ID</span> to add when clicked, and the button was set to prompt the user for a tag to add when clicked. There are several such&nbsp;actions.</p>
<ul>
<li><code>addparticipant</code> Prompt the suer for a wave address to add to the&nbsp;wave</li>
<li><code>reload</code> Reload the current&nbsp;wave</li>
<li><code>addtag</code> Prompt the user for a tag to&nbsp;add</li>
<li><p><code>setname</code> Prompt the user to set a username for posting
There is also the user list. It comes in two flavors, <code>{{participantlist}}</code> and <code>{{contributorlist}}</code>. The latter only works when inside a blip scope (the stuff inside <code>wavebody</code>). They’re special because they’re actually interactive. When the list is long, it shortens it and creates a link to&nbsp;expand.</p>
</li>
<li><p><code>participantlist</code> A list made from&nbsp;wave.participants</p>
</li>
<li><p><code>contributorlist</code> Only works when in <code>wavebody</code>, a simple users list made from blip.contributors
Now, is finally the stuff that goes in the blip. Like <code>wave</code> it extends some wave api features, so I’ll start with<a href="http://code.google.com/apis/wave/extensions/robots/protocol.html#Blips"> pasting what google has documented</a>.</p>
</li>
<li><p><code>blipId</code> contains the <span class="caps">ID</span> of blip in which the event&nbsp;occurred.</p>
</li>
<li><code>childBlipIds</code> contains an array of blip IDs for each of the blip’s&nbsp;children.</li>
<li><code>contributors</code> denotes participants who have contributed to the state of this&nbsp;blip.</li>
<li><code>creator</code> denotes the participant who created this&nbsp;blip.</li>
<li><code>lastModifiedTime</code> denotes the <a href="http://en.wikipedia.org/wiki/Unix_time">Unix time</a> at which this blip was last modified by any&nbsp;participant.</li>
<li><code>content</code> contains the textual content of this&nbsp;blip.</li>
<li><code>version</code> contains the version of this blip. Each atomic operation on a blip increases this version&nbsp;number.</li>
<li><code>waveId</code> contains the Wave <span class="caps">ID</span> associated with this&nbsp;blip.</li>
<li><p><code>waveletId</code> contains the wavelet <span class="caps">ID</span> associated with this blip. Note that for waves which contain only one wavelet (that don’t have private conversations, in other words), this wavelet ID is usually of the form <code>conv+root</code> indicating that the wavelet is identical to the conversation root, the root wave.
There are a few additional methods which, again are&nbsp;non-standard.</p>
</li>
<li><p><code>permalink</code> contains a link to the waveref which points to the specific blip on the real wave&nbsp;client</p>
</li>
<li><p><code>html</code> contains a string of the rendered (with formatting and annotations applied) content
There are also actions, similar to the global <code>addparticipant</code>, <code>reload</code> and <code>setname</code> actions. They can still be used within <code>wavebody</code> but there are some actions which can <em>only</em> work in the blip&nbsp;template.</p>
</li>
<li><p><code>edit</code> Add an edit box immediately below the blip, pre-populated with the text content of the&nbsp;blip</p>
</li>
<li><code>remove</code> Remove the blip, it will first issue a confirmation prompt to the&nbsp;user</li>
<li><p><code>reply</code> Add a reply box immediately below the blip. If there is already a blip below, the reply box is indented.
Below is a little example showing how to use the <code>blip</code> object.
<script type="text/javascript" src="http://gist.github.com/458980.js?file=wavebody.html"></script>Lastly is the <span class="caps">JS</span> part. Without it, nothing would ever show up. You need to include the currently 6.5KB JS library from <code>http://anony-bot.appspot.com/assets/embed2.mini.js</code>. After that, you need a separate script tag anywhere after the big hidden super element. It <em>must</em> be outside the super element (unimaginable evils will happen if it isn’t). Inside that script tag needs to be a function call to <code>w2_embed</code>. The first (and only) argument has to be a <span class="caps">JS</span> object with at least the <code>element</code> key pointing to a <span class="caps">DOM</span> element which contains an element with the class <code>wavebody</code>. There are <em>lots</em> of other config options, and here they&nbsp;are.</p>
</li>
<li><p><code>element</code> (Required) a dom element which contains a div with the “wavebody”&nbsp;class</p>
</li>
<li><code>identifier</code> The identifier for the wave that the server will use to generate a wave <span class="caps">ID</span> from, default:&nbsp;location.pathname</li>
<li><code>root_title</code> If the identifier has not previously been associated with a wave <span class="caps">ID</span>, the wave will be created with the specified title. default: (no&nbsp;title)</li>
<li><code>root_content</code> If the identifier has not previously been associated with a wave <span class="caps">ID</span>, the wave will be created with the specified content as the root blip. default: (no&nbsp;content)</li>
<li><code>participants</code> The participants the wave should be created with if not previously associated with a wave <span class="caps">ID</span>, default: [], suggested:&nbsp;[‘public@a.gwave.com’]</li>
<li><code>hideroot</code> Boolean whether or not to not render the root&nbsp;blip</li>
<li><code>edit</code> A reference to a <span class="caps">DOM</span> element which can be templated into the edit box, should contain handlers for the actions {{submit}} and {{cancel}} as well as a textarea with the class&nbsp;“wavetext”</li>
<li><code>tags</code> Set of tags to be added to the wave if the identifier has not previously been associated with a wave and must be&nbsp;created.</li>
<li><code>api_root</code> The domain containing the server component (proxy and dictionary server). Default:&nbsp;anony-bot.appspot.com</li>
<li><code>gadgets</code> Enable native gadgets (does not&nbsp;work)</li>
<li><code>render_state</code> Display the user a gadget&nbsp;state</li>
<li><code>chronological</code> Render blips chronologically (see Microwave’s “Classic Forum Layout”&nbsp;option)</li>
<li><code>json_url</code> Location of <span class="caps">JSON</span> implementation to be loaded dynamically in case it’s not native to the browser default: <a href="http://anony-bot.appspot.com/assets/json2.mini.js">http://anony-bot.appspot.com/assets/json2.mini.js</a></li>
<li><code>waveid</code> Skip the identifier lookup and directly reference a wave by it’s id&nbsp;&nbsp;</li>
</ul>
<p>You can see that the function call was saved to a variable named <code>demo</code>. That’s useful because you can use that to reference later to manipulate things. The return of a w2_embed call is a <span class="caps">JS</span> object with the following&nbsp;keys.</p>
<ul>
<li><code>config</code> A reference to the initial config&nbsp;object</li>
<li><code>reply(text)</code> Create a root-level&nbsp;reply</li>
<li><code>reload()</code> Reload the wave.
So lets try putting everything&nbsp;together.</li>
</ul>
<p>&nbsp;</p>
<p>Afterthoughts: Just a little thing to add at the end. You can can create a a div with the class <code>waveedit</code> as used above. It’s not strictly necessary, but it lets you customize things a bit more. You also need a <span class="caps">CSS</span> style for .wavethread with a padding-left (or margin-left) in order for threads to show up properly. Blips are automatically given a .waveblip&nbsp;class.</p>
<p>That screenshot on the top of the post, <a href="http://anony-bot.appspot.com/assets/test2.html">if you want to try it out. It’s here</a>.</p>
<p>I’m not making any money off of this, so there’s no reason for me to hide the fallibilities of this solution from anyone. This, like any other solution is not perfect. There is no true wave-style real-time editing, it uses polling. It does however update every 10 seconds if it’s configured to do so using the <code>poll_updates: true</code> configuration option. It can’t ever really do much better, since app engine doesn’t yet support pushing out real time data to attached clients, even though they announced the neat Channel <span class="caps">API</span> (still waiting to use it!) at I/O. Either way, that probably won’t help too much as w2_embed uses JSONP for client/server communication across multiple domains, and it’s unlikely that the channel api will allow for that. Also, since there’s no way to fetch a single blip, the user must request the entire wave to check the tiny 32 bit version integer if it’s been incremented, and if it has, then the whole wave has to be fetched again. It’s by no means efficient, and so my server would be very very sad if the polling interval was significantly increased. It’s not very SEO friendly. Though it’s not always that people want the comments to be indexed by search engines, so some people may care less. Accessibility-wise, it shouldn’t be too horrible if the screen reader/browser supports javascript and hugely depends on the HTML being used in conjunction with the&nbsp;script.</p>
<p>As of date, this was my longest blog post ever, and I would be sad if nobody commented (ironically using my non-wave-based commenting system). And I’m not posting my source code unless someone comments, so, an incentive&nbsp;:P</p>

            </section>
          </article>
          <hr>
          <div class="nav"><a href="/archive" class="newer">« Archives</a><a href="/page/1" class="next">Latest Posts »</a>
          </div>
        </div>
      </div>
    </div>
    <script>
      function squish(){
        document.getElementById("squishfoot").className += "squish"
      }
    </script>
    <style>
      .squish { font-size: 9px }
      .squishsquish { font-size: 8px }
      .squishsquishsquish { font-size: 7px }
      .squishsquishsquishsquish { font-size: 6px }
      .squishsquishsquishsquishsquish { font-size: 5px }
      .squishsquishsquishsquishsquishsquish { font-size: 4px }
      .squishsquishsquishsquishsquishsquishsquish { visibility: hidden }
    </style>
    <div class="graybar bottom">
      <footer>
        <div id="squishfoot">I'm a tiny footer, please don't <a href="javascript:squish()">squish</a> me</div>
      </footer>
    </div>
  </body>
</html>