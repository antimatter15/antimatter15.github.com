<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" href="http://antimatter15.com/feed.xml" type="application/rss+xml" title="somewhere to talk about ideas and projects and stuff like everyone else">
    <link rel="stylesheet" href="/style/main.css">
    <title>stuff</title>
  </head>
  <body>
    <div class="whitebox">
      <div class="graybar top">
        <header class="top">
          <div class="slogan">somewhere to talk about random ideas and projects like everyone else</div><a href="/">
            <h1 class="logo">
              stuff
               <span class="byline">by antimatter15</span>
            </h1></a>
        </header>
      </div>
      <div id="main">
        <div class="sidebar">
          <div class="about">
            <p class="emph">
              Hi. I’m <b>Kevin Kwok</b>, and I’m currently a junior at <b>MIT</b>, 
              and this is my obligatory online presence or whatever.  
            </p>
            <p>This is my little corner of the internet, where I talk about random projects and ideas and stuff. </p>
            <p>If you want to contact me or read obnoxiously nostalgic autobiographical trivia, check out the <a href="/about"> about </a>section.</p>
          </div><br>
          <section class="archive"><a href="/archive">
              <h2>Archive</h2></a>
            <ul>
              <li>
                <ul>
                  <li><a href="/2015/12"><span class="month">December</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/08"><span class="month">August</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/06"><span class="month">June</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/05"><span class="month">May</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/04"><span class="month">April</span> <span class="year">2015</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2014/12"><span class="month">December</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/07"><span class="month">July</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/06"><span class="month">June</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/05"><span class="month">May</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/04"><span class="month">April</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/03"><span class="month">March</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/02"><span class="month">February</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/01"><span class="month">January</span> <span class="year">2014</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2013/12"><span class="month">December</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/11"><span class="month">November</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/10"><span class="month">October</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/09"><span class="month">September</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/08"><span class="month">August</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/07"><span class="month">July</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/06"><span class="month">June</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/05"><span class="month">May</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/04"><span class="month">April</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/03"><span class="month">March</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/02"><span class="month">February</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/01"><span class="month">January</span> <span class="year">2013</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2012/12"><span class="month">December</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/11"><span class="month">November</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/10"><span class="month">October</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/09"><span class="month">September</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/08"><span class="month">August</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/07"><span class="month">July</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/06"><span class="month">June</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/05"><span class="month">May</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/04"><span class="month">April</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/03"><span class="month">March</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/02"><span class="month">February</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/01"><span class="month">January</span> <span class="year">2012</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2011/12"><span class="month">December</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/11"><span class="month">November</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/10"><span class="month">October</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/09"><span class="month">September</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/08"><span class="month">August</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/07"><span class="month">July</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/06"><span class="month">June</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/05"><span class="month">May</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/04"><span class="month">April</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/03"><span class="month">March</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/02"><span class="month">February</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/01"><span class="month">January</span> <span class="year">2011</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2010/12"><span class="month">December</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/11"><span class="month">November</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/10"><span class="month">October</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/09"><span class="month">September</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/08"><span class="month">August</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/07"><span class="month">July</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/06"><span class="month">June</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/05"><span class="month">May</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/04"><span class="month">April</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/03"><span class="month">March</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/02"><span class="month">February</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/01"><span class="month">January</span> <span class="year">2010</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2009/12"><span class="month">December</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/11"><span class="month">November</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/10"><span class="month">October</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/09"><span class="month">September</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/08"><span class="month">August</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/07"><span class="month">July</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/06"><span class="month">June</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/05"><span class="month">May</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/04"><span class="month">April</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/03"><span class="month">March</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/01"><span class="month">January</span> <span class="year">2009</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2008/12"><span class="month">December</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/11"><span class="month">November</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/10"><span class="month">October</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/09"><span class="month">September</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/08"><span class="month">August</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/07"><span class="month">July</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/06"><span class="month">June</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/05"><span class="month">May</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/04"><span class="month">April</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/01"><span class="month">January</span> <span class="year">2008</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2007/12"><span class="month">December</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/11"><span class="month">November</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/10"><span class="month">October</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/09"><span class="month">September</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/08"><span class="month">August</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/05"><span class="month">May</span> <span class="year">2007</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2006/09"><span class="month">September</span> <span class="year">2006</span></a></li>
                  <li><a href="/2006/08"><span class="month">August</span> <span class="year">2006</span></a></li>
                </ul><br>
              </li>
            </ul>
          </section>
          <div class="tags">
            <h2>Tags</h2><a href="/tag/3D" style="font-size: 13px">3D </a><a href="/tag/actionscript" style="font-size: 11px">actionscript </a><a href="/tag/ajax" style="font-size: 20px">ajax </a><a href="/tag/ajax animator" style="font-size: 20px">ajax animator </a><a href="/tag/animation" style="font-size: 11px">animation </a><a href="/tag/api" style="font-size: 13px">api </a><a href="/tag/apple" style="font-size: 20px">apple </a><a href="/tag/arduino" style="font-size: 11px">arduino </a><a href="/tag/art" style="font-size: 13px">art </a><a href="/tag/awesome" style="font-size: 13px">awesome </a><a href="/tag/blog" style="font-size: 19px">blog </a><a href="/tag/browser" style="font-size: 20px">browser </a><a href="/tag/bugfix" style="font-size: 15px">bugfix </a><a href="/tag/canvas" style="font-size: 15px">canvas </a><a href="/tag/change" style="font-size: 15px">change </a><a href="/tag/chrome" style="font-size: 20px">chrome </a><a href="/tag/chrome os" style="font-size: 11px">chrome os </a><a href="/tag/chromebook" style="font-size: 11px">chromebook </a><a href="/tag/code" style="font-size: 13px">code </a><a href="/tag/colors" style="font-size: 11px">colors </a><a href="/tag/css" style="font-size: 11px">css </a><a href="/tag/demo" style="font-size: 11px">demo </a><a href="/tag/design" style="font-size: 20px">design </a><a href="/tag/elitist" style="font-size: 20px">elitist </a><a href="/tag/evil" style="font-size: 19px">evil </a><a href="/tag/experiment" style="font-size: 15px">experiment </a><a href="/tag/extension" style="font-size: 20px">extension </a><a href="/tag/ExtJS" style="font-size: 20px">ExtJS </a><a href="/tag/fast" style="font-size: 20px">fast </a><a href="/tag/features" style="font-size: 15px">features </a><a href="/tag/firefox" style="font-size: 20px">firefox </a><a href="/tag/flash" style="font-size: 17px">flash </a><a href="/tag/format" style="font-size: 11px">format </a><a href="/tag/function" style="font-size: 13px">function </a><a href="/tag/future" style="font-size: 15px">future </a><a href="/tag/GAE" style="font-size: 13px">GAE </a><a href="/tag/github" style="font-size: 15px">github </a><a href="/tag/google" style="font-size: 20px">google </a><a href="/tag/google wave" style="font-size: 20px">google wave </a><a href="/tag/graphics" style="font-size: 17px">graphics </a><a href="/tag/hacking" style="font-size: 11px">hacking </a><a href="/tag/hardware" style="font-size: 11px">hardware </a><a href="/tag/history" style="font-size: 11px">history </a><a href="/tag/hosting" style="font-size: 19px">hosting </a><a href="/tag/html5" style="font-size: 19px">html5 </a><a href="/tag/idea" style="font-size: 13px">idea </a><a href="/tag/internet exploder" style="font-size: 20px">internet exploder </a><a href="/tag/ipad" style="font-size: 17px">ipad </a><a href="/tag/javascript" style="font-size: 20px">javascript </a><a href="/tag/json" style="font-size: 15px">json </a><a href="/tag/library" style="font-size: 11px">library </a><a href="/tag/lines" style="font-size: 13px">lines </a><a href="/tag/linux" style="font-size: 17px">linux </a><a href="/tag/login" style="font-size: 15px">login </a><a href="/tag/mac" style="font-size: 11px">mac </a><a href="/tag/magical" style="font-size: 15px">magical </a><a href="/tag/math" style="font-size: 11px">math </a><a href="/tag/meta" style="font-size: 13px">meta </a><a href="/tag/microsoft" style="font-size: 15px">microsoft </a><a href="/tag/microwave" style="font-size: 15px">microwave </a><a href="/tag/mp3" style="font-size: 11px">mp3 </a><a href="/tag/multitouch" style="font-size: 13px">multitouch </a><a href="/tag/new" style="font-size: 19px">new </a><a href="/tag/nostalgia" style="font-size: 11px">nostalgia </a><a href="/tag/ocr" style="font-size: 13px">ocr </a><a href="/tag/offline" style="font-size: 17px">offline </a><a href="/tag/old" style="font-size: 17px">old </a><a href="/tag/onlypaths" style="font-size: 17px">onlypaths </a><a href="/tag/pi" style="font-size: 19px">pi </a><a href="/tag/player" style="font-size: 11px">player </a><a href="/tag/progress" style="font-size: 11px">progress </a><a href="/tag/prototype" style="font-size: 13px">prototype </a><a href="/tag/python" style="font-size: 20px">python </a><a href="/tag/raphael" style="font-size: 19px">raphael </a><a href="/tag/release" style="font-size: 13px">release </a><a href="/tag/rewrite" style="font-size: 13px">rewrite </a><a href="/tag/school" style="font-size: 15px">school </a><a href="/tag/security" style="font-size: 15px">security </a><a href="/tag/shiny" style="font-size: 20px">shiny </a><a href="/tag/ShinyTouch" style="font-size: 13px">ShinyTouch </a><a href="/tag/simple" style="font-size: 11px">simple </a><a href="/tag/site" style="font-size: 13px">site </a><a href="/tag/small" style="font-size: 20px">small </a><a href="/tag/speed" style="font-size: 11px">speed </a><a href="/tag/SVG" style="font-size: 15px">SVG </a><a href="/tag/touch" style="font-size: 13px">touch </a><a href="/tag/update" style="font-size: 20px">update </a><a href="/tag/upload" style="font-size: 17px">upload </a><a href="/tag/user interface" style="font-size: 11px">user interface </a><a href="/tag/vector" style="font-size: 13px">vector </a><a href="/tag/vectoreditor" style="font-size: 19px">vectoreditor </a><a href="/tag/version" style="font-size: 13px">version </a><a href="/tag/video" style="font-size: 15px">video </a><a href="/tag/vision" style="font-size: 11px">vision </a><a href="/tag/vp8" style="font-size: 11px">vp8 </a><a href="/tag/vX JS" style="font-size: 19px">vX JS </a><a href="/tag/wave" style="font-size: 20px">wave </a><a href="/tag/wikify" style="font-size: 20px">wikify </a><a href="/tag/wikipedia" style="font-size: 17px">wikipedia </a><a href="/tag/wordpress" style="font-size: 20px">wordpress </a>
          </div>
        </div>
        <div id="content">
          <article class="article intro">
            <header>
              <h2><a href="/2015/12/recovering-deleted-data-from-leveldb/">Recovering Deleted Data from LevelDB</a> <span class="subtitle">02 December 2015</span></h2>
            </header>
            <section class="content"><p><div class="pic md right" style="width: 300px" ><img alt=""  src="/articles/2015/LevelDB%20Recovery/hex-medium.jpg" ></div></p>
<p>It was 4am this morning, and I did something stupid. I was trying to write something which would automatically delete all empty documents. Within a few seconds of running it, all my precious data was gone.&nbsp;Oops.</p>
<p>There’s probably some grander lesson to be learned about keeping routine backups and not being an idiot. But the strength of that parable is somewhat weakened because I did manage to get the data&nbsp;back. </p>
<h2 id="how-leveldb-works">How LevelDB&nbsp;Works</h2>
<p><a href="http://leveldb.org/">LevelDB</a>, developed by Sanjay Ghemawat and Jeff Dean of Google, is a fast key-value store based on a <a href="http://paperhub.s3.amazonaws.com/18e91eb4db2114a06ea614f0384f2784.pdf">log-structured merge tree</a>. </p>
<p>It’s not a relational database. It can’t do complex <span class="caps">SQL</span> queries. In fact, the only type of query that one can do is to ask for the set of entries whose keys fit lexicographically in some range. Think of it as a list of entities perpetually sorted by a key, where you can quickly read out any entry (or contiguous range) with a simple <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a>. </p>
<p>It’s not just a metaphor— the basic primitive underlying LevelDB is literally called an SSTable (Sorted String Table). If you have a big arbitrarily large sorted list, the task of locating any single entity in a sorted list can be done in O(log n) time, which is nice because hopping around the big spinning metal hard disk platter is glacially slow in computer&nbsp;time. </p>
<!-- What's worse— inserting some new entry or deleting an old one may involve rewriting the whole file! -->

<p>In <span class="caps">RAM</span>, hopping around is pretty fast. It’s part of the name— Random Access Memory. In RAM you can maintain a balanced <a href="https://en.wikipedia.org/wiki/Binary_search_tree">binary search tree</a>, so that you can search, insert, delete, or update the contents of any entry in O(log n) time— all while keeping the contents&nbsp;sorted. </p>
<p>Computers tend to have a limited amount of <span class="caps">RAM</span> compared to hard disk space, so most databases have to somehow deal with both beasts. To a certain extent, LevelDB plays to the strengths of each while using the other to fill in&nbsp;weaknesses. </p>
<p><div class="pic md" style="" ><img alt=""  src="/articles/2015/LevelDB%20Recovery/sstable-igvita.png" ><div class="caption">Diagram taken from https://www.igvita.com/2012/02/06/sstable-and-log-structured-storage-leveldb/</div></div>  </p>
<p>To add some entry to the key-value store, LevelDB first sticks it into <span class="caps">RAM</span>— in particular some sort of data structure that keeps everything all nice and sorted. But over time, this chunk of memory may grow uncomfortably large, at which point its sorted contents get flushed into a file, and the old chunk of memory is emptied and ready for new&nbsp;data. </p>
<p>Once data is saved to the disk, the saved SSTables are essentially treated as immutable. Otherwise, if you want to keep the data sorted you might have to rewrite the entire file whenever a new entry is added, or an old one is deleted. This immutability property is really what ends up saving me, because it means that in spite of deleting everything— nothing is ever truly&nbsp;lost. </p>
<p>To look up some range of entries, LevelDB first checks <span class="caps">RAM</span> in case something matching the query has been manipulated recently. Then it checks the little immutable chunks which have already been flushed to disk, and merges them all together quickly in a manner similar to <a href="https://en.wikipedia.org/wiki/Merge_sort">merge sort</a>. </p>
<p>There’s some more to it which I haven’t covered, such as an append-only log to aid recovery in the event of some catastrophic power failure or software crash, and the process by which older SSTables get compacted together. But this essentially represents the basic design of an <span class="caps">LSM</span> database, at least enough to understand the principle of recovering deleted&nbsp;files. </p>
<h2 id="leveldb-structure">LevelDB&nbsp;Structure</h2>
<p><div class="pic md right" style="width: 200px" ><img alt=""  src="/articles/2015/LevelDB%20Recovery/files-medium.jpg" ></div></p>
<p>When you save some stuff to a LevelDB database, what you find is actually a directory consisting of a couple of <code>.log</code> files, <code>.ldb</code> files, <code>MANIFEST</code>, <code>CURRENT</code>, <code>LOG</code> and <code>LOCK</code>. As far as I’m aware the log files are temporary and kept in case the database is interrupted before it has an opportunity to write things down into a sorted table. Thus I’ll pretend that after having cleanly exited the database (following accidentally deleting lots of stuff), all the content which might possibly be interesting is within the <code>.ldb</code> files. </p>
<p>If you try to open up an <code>.ldb</code> in a hex editor, you’ll notice bits which look tantalizingly like the data you might want to recover, albeit subtly mangled by the Snappy compression&nbsp;algorithm. </p>
<h2 id="recovery">Recovery</h2>
<p>While you might imagine that being able to access previous versions of the data would be a natural and obvious affordance for a log-structured immutable append-only key-value store, I couldn’t find any APIs for accessing deleted&nbsp;data. </p>
<p>A good first step might be figuring out some way to parse those <code>.ldb</code> files. Fortunately, it’s <a href="https://leveldb.googlecode.com/svn/trunk/doc/table_format.txt">well-documented enough</a> that there are actually <a href="https://github.com/golang/leveldb/blob/master/table/table.go">third-party implementations</a>. And from the looks of it’s actually pretty&nbsp;simple.</p>
<p>That golang leveldb repo is particularly cool because it includes a helper tool <code>ldbdump</code> which reads in an <code>.ldb</code> file and dumps its contents. In fact the whole process of using it was surprisingly rather painless. I just ran <code>go get github.com/golang/leveldb</code>, navigated to the <code>cmd/ldbdump</code> directory and ran <code>go build -o ldbdump main.go</code>. I then wrote a little Python script which would call that program for all the <code>.ldb</code> files in a particular directory and parse it into a more canonical <span class="caps">JSON</span>&nbsp;form. </p>
<pre><code><span style='display:none' detected-language='processing'></span>base = <span class="hljs-string">"test-stuff copy"</span>

<span class="hljs-keyword">import</span> os
from subprocess <span class="hljs-keyword">import</span> Popen, <span class="caps">PIPE</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> ast
<span class="hljs-keyword">for</span> f in os.listdir(base):
  <span class="hljs-keyword">if</span> f.endswith(<span class="hljs-string">".ldb"</span>):
    process = Popen([<span class="hljs-string">"ldbdump"</span>, os.path.<span class="hljs-built_in">join</span>(base, f)], stdout=<span class="caps">PIPE</span>)
    (output, err) = process.communicate()
    exit_code = process.wait()
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">line</span> in (output.<span class="hljs-built_in">split</span>(<span class="hljs-string">"\n"</span>)[<span class="hljs-number">1</span>:]):
      <span class="hljs-keyword">if</span> <span class="hljs-built_in">line</span>.strip() == <span class="hljs-string">""</span>: <span class="hljs-keyword">continue</span>
      parsed = ast.literal_eval(<span class="hljs-string">"{"</span> + <span class="hljs-built_in">line</span> + <span class="hljs-string">"}"</span>)
      <span class="hljs-variable">key</span> = parsed.keys()[<span class="hljs-number">0</span>]
      <span class="hljs-built_in">print</span> json.dumps({ <span class="hljs-string">"key"</span>: <span class="hljs-variable">key</span>.encode(<span class="hljs-string">'string-escape'</span>), <span class="hljs-string">"value"</span>: parsed[<span class="hljs-variable">key</span>] })
</code></pre><p>Out of this I got a <span class="caps">73MB</span> JSON file, which seemed to have all the contents in some form but unfortunately ordered by the key. This is bad because it conflates different versions of a particular key— an object may have been changed, deleted, and created&nbsp;again.  </p>
<pre><code><span style='display:none' detected-language='tex'></span><span class="hljs-special">{</span>"value": "<span class="hljs-special">{</span><span class="hljs-command">\"</span>id<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Whole Earth Catalog<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>type<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>text<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>parent<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>__root__<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>created<span class="hljs-command">\"</span>:1447821578094,<span class="hljs-command">\"</span>list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-command">\"</span><span class="caps">MI11NZ</span><span class="hljs-command">\"</span><span class="hljs-special">]</span><span class="hljs-special">}</span>", "key": "!entities/aleph!Whole Earth Catalog<span class="hljs-command">\\</span>x01RI<span class="hljs-command">\\</span>x05<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00"<span class="hljs-special">}</span>
<span class="hljs-special">{</span>"value": "<span class="hljs-special">{</span><span class="hljs-command">\"</span>id<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Wikia<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>type<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>text<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>parent<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>__root__<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>created<span class="hljs-command">\"</span>:1447821578094,<span class="hljs-command">\"</span>list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-command">\"</span><span class="caps">XB8UAU</span><span class="hljs-command">\"</span><span class="hljs-special">]</span><span class="hljs-special">}</span>", "key": "!entities/aleph!Wikia<span class="hljs-command">\\</span>x01UI<span class="hljs-command">\\</span>x05<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00"<span class="hljs-special">}</span>
<span class="hljs-special">{</span>"value": "<span class="hljs-special">{</span><span class="hljs-command">\"</span>id<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Will Ferrell<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>type<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>text<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>parent<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>__root__<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>created<span class="hljs-command">\"</span>:1447841260204,<span class="hljs-command">\"</span>list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-command">\"</span><span class="caps">AKVVBF</span><span class="hljs-command">\"</span><span class="hljs-special">]</span><span class="hljs-special">}</span>", "key": "!entities/aleph!Will Ferrell<span class="hljs-command">\\</span>x01=N<span class="hljs-command">\\</span>x05<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00"<span class="hljs-special">}</span>
</code></pre><p>One curious thing I noticed was the presence of some strange binary digits after the end of each key. After a little bit of experimentation it turns out that if you convert that binary string into a number, and sort the entire database by it, sticks all the changes in the proper chronological&nbsp;order!</p>
<pre><code><span style='display:none' detected-language='processing'></span><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> ast 
<span class="hljs-keyword">import</span> binascii

things = []
<span class="hljs-keyword">for</span> <span class="hljs-built_in">line</span> in sys.stdin:
  obj = json.loads(<span class="hljs-built_in">line</span>)
  halves = obj[<span class="hljs-string">'key'</span>].<span class="hljs-built_in">split</span>(<span class="hljs-string">"\\x"</span>, <span class="hljs-number">1</span>)
  <span class="hljs-variable">key</span> = ast.literal_eval(<span class="hljs-string">"'\\x"</span> + halves[<span class="hljs-number">1</span>].replace(<span class="hljs-string">"\\\\u00"</span>, <span class="hljs-string">"\\x"</span>) + <span class="hljs-string">"'"</span>)
  <span class="hljs-keyword">if</span> len(<span class="hljs-variable">key</span>) == <span class="hljs-number">8</span>:
    time = <span class="hljs-built_in">int</span>(binascii.hexlify(<span class="hljs-variable">key</span>[<span class="hljs-number">1</span>:][::-<span class="hljs-number">1</span>]), <span class="hljs-number">16</span>)
    things.<span class="hljs-built_in">append</span>((time, halves[<span class="hljs-number">0</span>], obj[<span class="hljs-string">'value'</span>]))

<span class="hljs-keyword">for</span> x in sorted(things, <span class="hljs-variable">key</span> = lambda k: k[<span class="hljs-number">0</span>]):
  <span class="hljs-built_in">print</span> json.dumps(x)
</code></pre><p>And my precious data is now saved! Or well, rather, it always was— but now I finally have access to it in some reasonable&nbsp;form. </p>
<p>I could see the first few entries, which happened to be some particularly fecal test&nbsp;data</p>
<pre><code><span style='display:none' detected-language='json'></span>[<span class="hljs-number">1</span>, <span class="hljs-string">"!changes/wumbo/!00000001448849217216"</span>, <span class="hljs-string">"poop"</span>]
[<span class="hljs-number">2</span>, <span class="hljs-string">"!entities/wumbo/!00000001448849471307"</span>, <span class="hljs-string">"poop"</span>]
[<span class="hljs-number">3</span>, <span class="hljs-string">"!changes/wumbo/!00000001448849471308"</span>, <span class="hljs-string">"poop"</span>]
</code></pre><p>Then some data in the middle with an imported movie&nbsp;database</p>
<pre><code><span style='display:none' detected-language='json'></span>[<span class="hljs-number">2435</span>, <span class="hljs-string">"!changes/merp!000000014488557172160000001163"</span>, <span class="hljs-string">"Deja Vu"</span>]
[<span class="hljs-number">2437</span>, <span class="hljs-string">"!changes/merp!000000014488557172160000001164"</span>, <span class="hljs-string">"Gattaca"</span>]
[<span class="hljs-number">2439</span>, <span class="hljs-string">"!changes/merp!000000014488557172170000001165"</span>, <span class="hljs-string">"Sunshine"</span>]
</code></pre><p>And of course, the part of it where I accidentally deleted&nbsp;everything</p>
<pre><code><span style='display:none' detected-language='json'></span>[<span class="hljs-number">394061</span>, <span class="hljs-string">"!entities/aleph!<span class="caps">OYHEDW</span>"</span>, <span class="hljs-string">""</span>]
[<span class="hljs-number">394062</span>, <span class="hljs-string">"!entities/aleph!Gerry Sussman"</span>, <span class="hljs-string">""</span>]
[<span class="hljs-number">394063</span>, <span class="hljs-string">"!entities/aleph!<span class="caps">VSPKP8</span>"</span>, <span class="hljs-string">""</span>]
</code></pre><p>So I guess that’s it! In case you ever get stuck in a rut where you’ve unwittingly deleted the contents of your LevelDB and forgot to keep decent backups, and you’re lucky enough that the changes haven’t been compactified yet, you can possibly get your data&nbsp;back. </p>
<!-- 
There was a bit of a puzzle left, which was whether or not it was a timestamp. The first entry in the database was pretty small— just 78,128. I assumed that the epoch was set at the creation of the database, and from then kept counting. At the end of the file, that prefix number grew quite substantially to an 11 digit number.

    [78128, "!changes/wumbo/!00000001448849217216", "poop"]
    ...
    [26339520816, "!entities/aleph!@WZ1Y8ZF6F7594YEM$", "{\"type\":\"text\",\"id\":\"@WZ1Y8ZF6F7594YEM$\",\"text\":\"Scratchpad 1\",\"parent\":\"2 December 2015\",\"created\":1449050780995,\"list\":[]}"]

I had a few entries in the database that were actually tagged with timestamps, so I figured why not try to plot them against each other to see if there was a linear correspondence. 

![](plotly.png)

So it definitely didn't correspond linearly to a UNIX timestamp, but it did happen to look a lot like my own usage of the database. I had a big import at some point, and sort of slow, peaky interactions since then. I was also little curious what the spacing was. It turns out that each each one was exactly 131,072 apart from each other (which is kind of odd, because counters tend to go in increments of, well, one). A friend noticed 131,072 was 2^17, and so I . 
 -->



<pre><code><span style='display:none' detected-language='x86asm'></span><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">57</span> <span class="caps">FB</span> <span class="hljs-number">80</span> 8B <span class="hljs-number">24</span> <span class="hljs-number">75</span> <span class="hljs-number">47</span> <span class="hljs-pseudo"><span class="caps">DB</span></span>
</code></pre>
            </section>
          </article>
          <hr>
          <article class="article intro">
            <header>
              <h2><a href="/2015/08/optimistically-buying-an-excessive-number-of-lg-optimus-exceed-2/">Optimistically Buying an Excessive Number of LG Optimus Exceed 2</a> <span class="subtitle">30 August 2015</span></h2>
            </header>
            <section class="content"><p><div class="pic md right" style="width: 300px" ><img alt=""  src="/articles/2015/Cheap%20Smartphone/all-medium.jpg" ></div></p>
<p>At some point I developed a habit of perusing Slickdeals. I don’t have all that much disposable income, so I’ve been able to generally avoid making particularly embarassing and regrettable purchases. But some time in late August, I just saw a deal that was too good not to blow a hundred dollars&nbsp;on. </p>
<p>Best Buy was having a sale for the <a href="http://slickdeals.net/f/8173166-lg-optimus-exceed-2-no-contract-cell-phone-verizon-wireless-prepaid-7-99?src=SiteSearchV2">prepaid <span class="caps">LG</span> Optimus Exceed 2</a> Android Smartphone. It’s prepaid which means that there’s no service contract involved, and there’s a little <a href="https://en.wikipedia.org/wiki/Konami_Code">Konami-code</a> esque incation to avoid activation (volume up, volume down, back button, home&nbsp;button). </p>
<p>The specs are pretty respectable for something that costs less than a Chipotle burrito bowl. It has a dual-core 1.2GHz processor, 4.5” 800x400 capacitive touchscreen, a <span class="caps">5MP</span> rear camera (no selfiecam, which is a tad unfortunate) with an LED flash, a microSD slot, 4GB of internal flash, 1GB of RAM, Android 4.4.2 KitKat, a 2100mAh battery, WiFi, and Bluetooth 4.0 LE + EDR. It’s carrier-locked to Verizon (it has no SIM card), so it’s better to think of it as an iPod Touch replacement, or as I do— a neat hunk of cheap&nbsp;hardware.</p>
<p>So I bought something like a dozen of them. I ended up selling a couple to friends, so it wasn’t too ridiculously excessive, but I’ve still got a stack of four or so laying around collecting dust. But I’ve been struggling to find things to do with&nbsp;them. </p>
<h2 id="spotify-connect-alarm-clock">Spotify Connect / Alarm&nbsp;Clock</h2>
<p><div class="pic md right" style="width: 200px" ><img alt=""  src="/articles/2015/Cheap%20Smartphone/spotify-medium.jpg" ></div></p>
<p>A first, relatively uncreative thought was to command-strip it to the wall next to my bed. This way I don’t have to fumble around looking for my phone to Google something at 2am. I can use the text-to-speech capabilities of Android to transcribe ideas that I&nbsp;have. </p>
<p>I’ve hooked it up to some speakers that I’ve similarly mounted on the wall (I’m really quite a fan of command strips as a means of affixing objects to surfaces), so I can use the Spotify Connect to play music from my computer on my speakers (it’s slightly cooler than using Bluetooth because I can close my computer’s lid and the music continues&nbsp;playing). </p>
<h2 id="time-lapse-photography">Time Lapse&nbsp;Photography</h2>
<p><div class="pic md right" style="width: 200px" ><img alt=""  src="/articles/2015/Cheap%20Smartphone/fisheye.JPG-medium.jpg" ></div></p>
<p>I’ve taken two of these phones and I’m using them for somewhat longer term time lapse recording projects. To a certain extent, it’s just because I have literally nothing better to do with&nbsp;it. </p>
<p>I got a couple of those cheap $2 fisheye smartphone lens attachments from Amazon. I took one and hot glued it in place on the back of the phone, and stuck it facing my&nbsp;window. </p>
<p>There’s another smartphone perched on a little bit of cardboard with a view of a little&nbsp;houseplant. </p>
<h2 id="teardown-ir-camera-microscopy">Teardown / <span class="caps">IR</span> Camera /&nbsp;Microscopy</h2>
<p><div class="pic md right" style="width: 200px" ><img alt=""  src="/articles/2015/Cheap%20Smartphone/macro.JPG-medium.jpg" ></div></p>
<p>There’s an idea that I’ve been wanting to try for quite some time relating to infrared photography. I’ve been afraid to mess with most my cameras, because most of the cameras that I have aren’t particularly disposable. These phones, on the other hand, are entirely&nbsp;disposable. </p>
<p>So I went and took apart the phone in hopes of removing the <span class="caps">IR</span> filter. Unfortunately, when trying to pry off the outer lens, I was a bit indelicate and ended up smashing the lens into little bits, to the extent that it was no longer possible to take pictures at&nbsp;all. </p>
<p><div class="pic md right" style="width: 200px" ><img alt=""  src="/articles/2015/Cheap%20Smartphone/blob-medium.jpg" ></div></p>
<p>That said, I was able to go into a dark closet and press the button on an <span class="caps">IR</span> remote and the sensor was not only able to detect see the light, but to register the increase in brightness of a scene invisibly lit by the tiny IR&nbsp;led. </p>
<p>I’ve seen other people do microscopy with cheap smartphones by ripping out the lens and putting the sample directly on top of the <span class="caps">CCD</span>. Since I’ve already accidentally ripped out the lens, I figured why not try it out by putting a blob of saliva with a Q-tip on the&nbsp;sensor. </p>
<p>I think if you run the numbers, the resolution is something in the ballpark of 5µm, so that blob is thousands of times larger than a cell. In fact it’s quite unlikely to be able to see or distinguish individual cell features with a phone camera of this&nbsp;resolution. </p>
<h2 id="connecting-to-arduino">Connecting to&nbsp;Arduino</h2>
<p>One of my main reasons for getting this cheap smartphone is that it’s just so much cheaper than an Arduino, and just so much more powerful in comparison. You get all these sensor capabilities— an accelerometer and gyroscope, touchscreen and high resolution display, bluetooth and&nbsp;WiFi. </p>
<p>The problem is that smartphones don’t have <span class="caps">GPIO</span> pins, or even any serial ports. One thing the phone does have, however is&nbsp;an </p>

            </section>
          </article>
          <hr>
          <article class="article intro">
            <header>
              <h2><a href="/2015/06/handwriting-recognition-with-microcontrollers/">Handwriting Recognition with Microcontrollers</a> <span class="subtitle">30 June 2015</span></h2>
            </header>
            <section class="content"><p><div class="pic md" style="" ><img alt=""  src="/articles/2015/6.115/IMG_0258.jpg" ></div></p>
<p>For my final project in <a href="http://web.mit.edu/6.115/www/">6.115</a>, a microcomputer electronics class which I (and apparently nobody else) affectionately refer to as “leeblab”, I built a simple gestural input system. At its core lies an ordinary 8x8 <span class="caps">LED</span> matrix hacked into a low-res CCD and display coupled with a gutted expo dry erase marker used as a light pen. And per class requirements, it used a rube goldbergian cascade of TTL logic, an 8051, Cypress PSoC 5, an Arduino Pro Mini to process and massage the signals into USB HID compliant form, so that a computer might be able to use the contraption as a&nbsp;keyboard.</p>
<p><div class="pic md" style="" ><img alt=""  src="/articles/2015/6.115/IMG_0268.JPG" ></div></p>
<p>I had an 8x8 <span class="caps">LED</span> matrix laying around, and ‘twas the season that I had to come up with a final project for 6.115, a microcomputer electronics lab class. I vaguely recalled that an individual LED would generate a potential difference if you pummel it with enough photons. So I figured a cool and somewhat clever thing to do would be to create a display which could simultaneously act as a camera (pretty <a href="https://en.wikipedia.org/wiki/Telescreen">orweillian</a> in&nbsp;retrospect). </p>
<p><div class="pic md right" style="width: 300px" ><img alt=""  src="/articles/2015/6.115/matrix-pinout-medium.jpg" ><div class="caption">I&#39;m not totally sure about this, but I think this was the pinout of the <span class="caps">LED</span> matrix that I had. Notice that there doesn&#39;t seem to be any sensible mapping between spatial position and the corresponding pins</div></div></p>
<p>The <span class="caps">LED</span> matrix was something like <a href="https://www.adafruit.com/products/455">this one</a>. It’s wired using a technique called <a href="https://en.wikipedia.org/wiki/Charlieplexing">charlieplexing</a>, where there’s a long wire along each row that connects the anodes of the LEDs, and another long weire along each column which connects the cathodes (modulo&nbsp;dyslexia). </p>
<p>You can imagine taking a battery and a few clips and touching one point along the row wires and another point on the column wires and see a single pixel light up at the intersection of those columns and&nbsp;rows. </p>

            </section>
          </article>
          <hr>
          <article class="article intro">
            <header>
              <h2><a href="/2015/06/eulerian-video-magnification-in-the-browser/">Eulerian Video Magnification in the Browser</a> <span class="subtitle">30 June 2015</span></h2>
            </header>
            <section class="content"><p><div class="pic md" style="" ><img alt=""  src="/articles/2015/EVM/evm.png" ></div></p>
<p>Welcome to the exciting June edition of <em>Tales From The Backlog</em>. This particular entry is from two semesters ago, when I took <a href="http://6.869.csail.mit.edu/fall14/">6.819/6.869 Advances in Computer Vision</a> taught by Professor <a href="https://billf.mit.edu/">Bill Freeman</a> and <a href="http://web.mit.edu/torralba/www/">Antonio Torralba</a>. </p>
<p>For our final project, we had to reproduce some computer vision algorithm from a list. One of them was <a href="http://people.csail.mit.edu/mrub/vidmag/">Eulerian Video Magnification</a>, that cool demo which has made its rounds on Hacker News on several&nbsp;occasions. </p>

            </section>
          </article>
          <hr>
          <article class="article intro">
            <header>
              <h2><a href="/2015/05/cooley-tukey-fft-dct-idct-in-under-1k-of-javascript/">Cooley-Tukey FFT + DCT + IDCT in under 1K of Javascript</a> <span class="subtitle">30 May 2015</span></h2>
            </header>
            <section class="content"><p><div class="pic md right" style="width: 300px" ><img alt=""  src="/articles/2015/MiniFFT/hough-medium.jpg" ><div class="caption">Technically this is a Hough transform and isn&#39;t at all related to the <span class="caps">FFT</span>*, but it looks a lot cooler than any of the actual FFT/DCT pictures I have, so I might as well stick it here</div></div></p>
<p>Almost a year ago, I wrote a simple script for computing perceptual hashes in Javascript (it’s going to be part of a forthcoming Naptha feature which allows it recognize source images for memes and do perfect inpainting). One step of the process is computing the 2D Discrete Cosine Transform of a shrunken version of the&nbsp;image. </p>
<p>The problem is that step was kind of ridiculously slow, and it’s not really hard to see why: there’s a series of four nested for loops— because that’s the obvious naive way for computing the&nbsp;<span class="caps">DCT</span>. </p>
<p>In practice, it’s actually not all that bad because you only have to do it once per image, and the dimensions of the source image are a fixed 32x32. But it still felt pretty bad, so when I was looking over the code again earlier this week, I tried doing some research to figure out a faster way to do the&nbsp;<span class="caps">DCT</span>. </p>
<p>Surely you’d imagine that there have to be extraordinarily efficient implements of the <span class="caps">DCT</span> out there, given that it’s the very foundation of JPEG out there. And you’d be right, but they’ve generally unrolled the butterfly into a series of bit-shifts which are quite unlikely to generalize beyond the 8x8 block&nbsp;size. </p>
<p>I’m reasonably confident that <span class="caps">FFTW3</span> has a fast DCT implementation which also is capable of generalization, but it seems buried within quite a lot of&nbsp;code. </p>
<h2 id="minifft">MiniFFT</h2>
<p>This isn’t a super performant implementation, but it’s not horrendously slow and it doesn’t use recursion. It’s probably pretty trivial to make it quite a bit faster by precomputing sine and cosine tables. This uses the standard Cooley-Tukey radix-2 decimation-in-time algorithm, which means it only works for one dimensional arrays with a length which is a power of&nbsp;two. </p>
<p>It doesn’t check that the length is a power of two, it’ll just give you the wrong answer. You should definitely check that it’s true&nbsp;beforehand.</p>
<pre><code><span style='display:none' detected-language='javascript'></span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">miniFFT</span><span class="hljs-params">(re, im)</span> </span>{
    <span class="hljs-keyword">var</span> N = re.length;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, h = i, k = N; k &gt;&gt;= <span class="hljs-number">1</span>; h &gt;&gt;= <span class="hljs-number">1</span>)
            j = (j &lt;&lt; <span class="hljs-number">1</span>) | (h <span class="amp">&amp;</span> <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (j &gt; i) {
            re[j] = [re[i], re[i] = re[j]][<span class="hljs-number">0</span>]
            im[j] = [im[i], im[i] = im[j]][<span class="hljs-number">0</span>]
        }
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> hN = <span class="hljs-number">1</span>; hN * <span class="hljs-number">2</span> &lt;= N; hN *= <span class="hljs-number">2</span>)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; N; i += hN * <span class="hljs-number">2</span>)
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = i; j &lt; i + hN; j++) {
                <span class="hljs-keyword">var</span> cos = <span class="hljs-built_in">Math</span>.cos(<span class="hljs-built_in">Math</span>.<span class="caps">PI</span> * (j - i) / hN),
                    sin = <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Math</span>.<span class="caps">PI</span> * (j - i) / hN)
                <span class="hljs-keyword">var</span> tre =  re[j+hN] * cos + im[j+hN] * sin,
                    tim = -re[j+hN] * sin + im[j+hN] * cos;
                re[j + hN] = re[j] - tre; im[j + hN] = im[j] - tim;
                re[j] += tre; im[j] += tim;
            }
}
</code></pre><p>The transformation happens in place, so it’ll modify whatever arrays you pass&nbsp;in. </p>
<pre><code><span style='display:none' detected-language='javascript'></span><span class="hljs-keyword">var</span> re = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],
    im = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];
miniFFT(re, im);
<span class="hljs-built_in">console</span>.log(re, im); <span class="hljs-comment">// [ 10, -2, -2, -2 ] [ 0, 2, 0, -2 ]</span>
</code></pre><p>Minified, it’s only 359 bytes. Unlike this <a href="https://gist.github.com/wrayal/995571">other contender</a> for the dubious prize of smallest javascript <span class="caps">FFT</span> implementation, it doesn’t require a special complex number library three times its size (though this doesn’t fit in a tweet— I’ll be really impressed if someone manages to do&nbsp;that). </p>
<p>I haven’t really golfed the code to the smallest size possible, but I think it’s at a reasonable balance of brevity while still being somewhat&nbsp;comprehensible.</p>
<p>It’s based on an in-place <span class="caps">FFT</span> from <a href="http://introcs.cs.princeton.edu/java/97data/InplaceFFT.java.html">Princeton’s intro <span class="caps">CS</span></a> class <a href="http://www.nayuki.io/res/free-small-fft-in-multiple-languages/fft.js">Project Nayuki’s <span class="caps">FFT</span></a>.</p>
<h2 id="miniifft">MiniIFFT</h2>
<p>Turns out that you can invert the <span class="caps">FFT</span> modulo a scaling factor just by swapping the real and imaginary&nbsp;arguments.</p>
<pre><code><span style='display:none' detected-language='matlab'></span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">miniIFFT</span><span class="hljs-params">(re, im)</span>{</span>
    miniFFT(im, re);
    <span class="hljs-keyword">for</span>(var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>, N = re.<span class="hljs-built_in">length</span>; <span class="hljs-built_in">i</span> &lt; N; <span class="hljs-built_in">i</span>++)<span class="hljs-cell">{
        im[i] /= N;
        re[i] /= N;
    }</span>
}
</code></pre><h2 id="minidct">MiniDCT</h2>
<p>This is an implementation of a Type-<span class="caps">II</span> DCT using MiniFFT. For details about Makhoul’s algorithm for transforming a DCT into an FFT, see <a href="http://dsp.stackexchange.com/a/10606">this&nbsp;post</a></p>
<pre><code><span style='display:none' detected-language='matlab'></span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">miniDCT</span><span class="hljs-params">(s)</span>{</span>
    var N = s.<span class="hljs-built_in">length</span>,
        K = -Math.<span class="caps">PI</span> / (<span class="hljs-number">2</span> * N),
        re = new Float64Array(N),
        im = new Float64Array(N);
    <span class="hljs-keyword">for</span>(var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>, <span class="hljs-built_in">j</span> = N; <span class="hljs-built_in">j</span> &gt; <span class="hljs-built_in">i</span>; <span class="hljs-built_in">i</span>++)<span class="hljs-cell">{
        re[i] = s[i * <span class="hljs-number">2</span>]
        re[--j] = s[i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>]
    }</span>
    miniFFT(re, im)
    <span class="hljs-keyword">for</span>(var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>; <span class="hljs-built_in">i</span> &lt; N; <span class="hljs-built_in">i</span>++)
        s<span class="hljs-matrix">[i]</span> = <span class="hljs-number">2</span>*re<span class="hljs-matrix">[i]</span>*Math.<span class="hljs-built_in">cos</span>(K*<span class="hljs-built_in">i</span>)-<span class="hljs-number">2</span>*im<span class="hljs-matrix">[i]</span>*Math.<span class="hljs-built_in">sin</span>(K*<span class="hljs-built_in">i</span>);
}
</code></pre><p>Like MiniFFT, it operates in-place (well, not really, but it writes its output to the source&nbsp;array).</p>
<pre><code><span style='display:none' detected-language='javascript'></span><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>];
miniDCT(arr);
<span class="hljs-built_in">console</span>.log(arr); <span class="hljs-comment">// [ 30, -5.09493566, 7.0710678118, -8.604744653 ]</span>
</code></pre><p>It produces the same output as scipy’s fftpack, but Matlab’s <span class="caps">DCT</span> uses orthogonal normalization and produces a different result. However, it’s pretty simple to do it the Matlab way— just scale everything by 1/sqrt(2 * N) and divide the first element by&nbsp;sqrt(2).</p>
<pre><code><span style='display:none' detected-language='matlab'></span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matlabDCT</span><span class="hljs-params">(arr)</span>{</span>
    miniDCT(arr)
    arr<span class="hljs-matrix">[<span class="hljs-number">0</span>]</span> /= Math.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">2</span>);   
    <span class="hljs-keyword">for</span>(var <span class="hljs-built_in">i</span> = <span class="hljs-number">0</span>, N = arr.<span class="hljs-built_in">length</span>; <span class="hljs-built_in">i</span> &lt; N; <span class="hljs-built_in">i</span>++) arr<span class="hljs-matrix">[i]</span> /= Math.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">2</span> * N);
}
</code></pre><h2 id="miniidct">MiniIDCT</h2>
<p>I really considered renaming this series of functions into TinyFFT and friends because of the predicament of MiniIDCT— yeah, exactly— the horror— repeating&nbsp;I’s. </p>
<p>This is an implementation of a Type-<span class="caps">III</span> DCT, also known as the IDCT because it happens to be the inverse of a Type II DCT (frequently refered to as “<em>The</em>&nbsp;<span class="caps">DCT</span>”).  </p>
<pre><code><span style='display:none' detected-language='javascript'></span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">miniIDCT</span><span class="hljs-params">(s)</span></span>{
    <span class="hljs-keyword">var</span> N = s.length,
        K = <span class="hljs-built_in">Math</span>.<span class="caps">PI</span> / (<span class="hljs-number">2</span> * N),
        im = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>(N),
        re = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>(N);
    re[<span class="hljs-number">0</span>] = s[<span class="hljs-number">0</span>] / N / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; N; i++){
        <span class="hljs-keyword">var</span> im2 = <span class="hljs-built_in">Math</span>.sin(i*K), re2 = <span class="hljs-built_in">Math</span>.cos(i*K);
        re[i] = (s[N - i] * im2 + s[i] * re2) / N / <span class="hljs-number">2</span>;
        im[i] = (im2 * s[i] - s[N - i] * re2) / N / <span class="hljs-number">2</span>;
    }
    miniFFT(im, re)
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; N / <span class="hljs-number">2</span>; i++){
        s[<span class="hljs-number">2</span> * i] = re[i]
        s[<span class="hljs-number">2</span> * i + <span class="hljs-number">1</span>] = re[N - i - <span class="hljs-number">1</span>]
    }
}
</code></pre><p>This is based on Tom Grydeland’s <a href="http://www.idlcoyote.com/tip_examples/idct.pro"><span class="caps">IDL</span></a> implementation of the&nbsp;<span class="caps">IDCT</span>. </p>
<p>Let’s start with a 8 element array of real numbers (<span class="caps">DCT</span>&nbsp;values).</p>
<pre><code><span style='display:none' detected-language='json'></span>[A, B, C, D, E, F, G, H]
</code></pre><p>From that it generates the corresponding complex values. Note that the real part is intact, and the complex part is the original array with its head chopped off and the rest of it flipped around and attached to a water&nbsp;balloon. </p>
<pre><code><span style='display:none' detected-language='mathematica'></span>[A, B, <span class="hljs-keyword">C</span>, <span class="hljs-keyword">D</span>, <span class="hljs-keyword">E</span>, F, G, H] - j[<span class="hljs-number">0</span>, H, G, F, <span class="hljs-keyword">E</span>, <span class="hljs-keyword">D</span>, <span class="hljs-keyword">C</span>, B]
</code></pre><p>Then the complex values are rotated by <code>exp(i * pi / (2 * N))</code> to get spectral components. After an <span class="caps">IFFT</span> that gets transformed&nbsp;into:</p>
<pre><code><span style='display:none' detected-language='json'></span>[a, h, c, f, e, d, g, b]
</code></pre><p>It took me a while to see what was going on there, but the even indices are map to the first half of the results, and the odd ones map to the second half in&nbsp;reverse</p>
<pre><code><span style='display:none' detected-language='swift'></span><span class="hljs-type">Scrambled</span>      a h <span class="hljs-built_in">c</span> f e d g b
<span class="hljs-type">Even</span> <span class="hljs-type">Indexed</span>   a   <span class="hljs-built_in">c</span>   e   g
<span class="hljs-type">Odd</span> <span class="hljs-type">Indexed</span>      h   f   d   b
<span class="hljs-type">Odd</span> <span class="hljs-type">Reversed</span>     b   d   f   h
<span class="hljs-type">Unscrabmled</span>    a b <span class="hljs-built_in">c</span> d e f g h
</code></pre>
            </section>
          </article>
          <hr>
          <div class="nav"><a href="/archive" class="newer">« Archives</a><a href="/page/2/" class="next">Next page »</a>
          </div>
        </div>
      </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-1367972-3', 'auto');
      ga('send', 'pageview');
      
    </script>
    <script>
      function squish(){
        document.getElementById("squishfoot").className += "squish"
      }
    </script>
    <style>
      .squish { font-size: 9px }
      .squishsquish { font-size: 8px }
      .squishsquishsquish { font-size: 7px }
      .squishsquishsquishsquish { font-size: 6px }
      .squishsquishsquishsquishsquish { font-size: 5px }
      .squishsquishsquishsquishsquishsquish { font-size: 4px }
      .squishsquishsquishsquishsquishsquishsquish { visibility: hidden }
    </style>
    <div class="graybar bottom">
      <footer>
        <div id="squishfoot">I'm a tiny footer, please don't <a href="javascript:squish()">squish</a> me</div>
      </footer>
    </div>
  </body>
</html>