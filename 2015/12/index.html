<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" href="http://antimatter15.com/feed.xml" type="application/rss+xml" title="somewhere to talk about ideas and projects and stuff like everyone else">
    <link rel="stylesheet" href="/style/main.css">
    <title>
      December 
      2015
    </title>
  </head>
  <body>
    <div class="whitebox">
      <div class="graybar top">
        <header class="top">
          <div class="slogan">somewhere to talk about random ideas and projects like everyone else</div><a href="/">
            <h1 class="logo">
              stuff
               <span class="byline">by antimatter15</span>
            </h1></a>
        </header>
      </div>
      <div id="main">
        <div class="sidebar">
          <div class="about">
            <p class="emph">
              Hi. I’m <b>Kevin Kwok</b>, and I’m currently a junior at <b>MIT</b>, 
              and this is my obligatory online presence or whatever.  
            </p>
            <p>This is my little corner of the internet, where I talk about random projects and ideas and stuff. </p>
            <p>If you want to contact me or read obnoxiously nostalgic autobiographical trivia, check out the <a href="/about"> about </a>section.</p>
          </div><br>
          <section class="archive"><a href="/archive">
              <h2>Archive</h2></a>
            <ul>
              <li>
                <ul>
                  <li><a href="/2015/12"><span class="month">December</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/08"><span class="month">August</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/06"><span class="month">June</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/05"><span class="month">May</span> <span class="year">2015</span></a></li>
                  <li><a href="/2015/04"><span class="month">April</span> <span class="year">2015</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2014/12"><span class="month">December</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/07"><span class="month">July</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/06"><span class="month">June</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/05"><span class="month">May</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/04"><span class="month">April</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/03"><span class="month">March</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/02"><span class="month">February</span> <span class="year">2014</span></a></li>
                  <li><a href="/2014/01"><span class="month">January</span> <span class="year">2014</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2013/12"><span class="month">December</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/11"><span class="month">November</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/10"><span class="month">October</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/09"><span class="month">September</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/08"><span class="month">August</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/07"><span class="month">July</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/06"><span class="month">June</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/05"><span class="month">May</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/04"><span class="month">April</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/03"><span class="month">March</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/02"><span class="month">February</span> <span class="year">2013</span></a></li>
                  <li><a href="/2013/01"><span class="month">January</span> <span class="year">2013</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2012/12"><span class="month">December</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/11"><span class="month">November</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/10"><span class="month">October</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/09"><span class="month">September</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/08"><span class="month">August</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/07"><span class="month">July</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/06"><span class="month">June</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/05"><span class="month">May</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/04"><span class="month">April</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/03"><span class="month">March</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/02"><span class="month">February</span> <span class="year">2012</span></a></li>
                  <li><a href="/2012/01"><span class="month">January</span> <span class="year">2012</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2011/12"><span class="month">December</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/11"><span class="month">November</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/10"><span class="month">October</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/09"><span class="month">September</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/08"><span class="month">August</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/07"><span class="month">July</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/06"><span class="month">June</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/05"><span class="month">May</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/04"><span class="month">April</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/03"><span class="month">March</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/02"><span class="month">February</span> <span class="year">2011</span></a></li>
                  <li><a href="/2011/01"><span class="month">January</span> <span class="year">2011</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2010/12"><span class="month">December</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/11"><span class="month">November</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/10"><span class="month">October</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/09"><span class="month">September</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/08"><span class="month">August</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/07"><span class="month">July</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/06"><span class="month">June</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/05"><span class="month">May</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/04"><span class="month">April</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/03"><span class="month">March</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/02"><span class="month">February</span> <span class="year">2010</span></a></li>
                  <li><a href="/2010/01"><span class="month">January</span> <span class="year">2010</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2009/12"><span class="month">December</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/11"><span class="month">November</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/10"><span class="month">October</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/09"><span class="month">September</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/08"><span class="month">August</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/07"><span class="month">July</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/06"><span class="month">June</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/05"><span class="month">May</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/04"><span class="month">April</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/03"><span class="month">March</span> <span class="year">2009</span></a></li>
                  <li><a href="/2009/01"><span class="month">January</span> <span class="year">2009</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2008/12"><span class="month">December</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/11"><span class="month">November</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/10"><span class="month">October</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/09"><span class="month">September</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/08"><span class="month">August</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/07"><span class="month">July</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/06"><span class="month">June</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/05"><span class="month">May</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/04"><span class="month">April</span> <span class="year">2008</span></a></li>
                  <li><a href="/2008/01"><span class="month">January</span> <span class="year">2008</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2007/12"><span class="month">December</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/11"><span class="month">November</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/10"><span class="month">October</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/09"><span class="month">September</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/08"><span class="month">August</span> <span class="year">2007</span></a></li>
                  <li><a href="/2007/05"><span class="month">May</span> <span class="year">2007</span></a></li>
                </ul><br>
              </li>
              <li>
                <ul>
                  <li><a href="/2006/09"><span class="month">September</span> <span class="year">2006</span></a></li>
                  <li><a href="/2006/08"><span class="month">August</span> <span class="year">2006</span></a></li>
                </ul><br>
              </li>
            </ul>
          </section>
          <div class="tags">
            <h2>Tags</h2><a href="/tag/3D" style="font-size: 13px">3D </a><a href="/tag/actionscript" style="font-size: 11px">actionscript </a><a href="/tag/ajax" style="font-size: 20px">ajax </a><a href="/tag/ajax animator" style="font-size: 20px">ajax animator </a><a href="/tag/animation" style="font-size: 11px">animation </a><a href="/tag/api" style="font-size: 13px">api </a><a href="/tag/apple" style="font-size: 20px">apple </a><a href="/tag/arduino" style="font-size: 11px">arduino </a><a href="/tag/art" style="font-size: 13px">art </a><a href="/tag/awesome" style="font-size: 13px">awesome </a><a href="/tag/blog" style="font-size: 19px">blog </a><a href="/tag/browser" style="font-size: 20px">browser </a><a href="/tag/bugfix" style="font-size: 15px">bugfix </a><a href="/tag/canvas" style="font-size: 15px">canvas </a><a href="/tag/change" style="font-size: 15px">change </a><a href="/tag/chrome" style="font-size: 20px">chrome </a><a href="/tag/chrome os" style="font-size: 11px">chrome os </a><a href="/tag/chromebook" style="font-size: 11px">chromebook </a><a href="/tag/code" style="font-size: 13px">code </a><a href="/tag/colors" style="font-size: 11px">colors </a><a href="/tag/css" style="font-size: 11px">css </a><a href="/tag/demo" style="font-size: 11px">demo </a><a href="/tag/design" style="font-size: 20px">design </a><a href="/tag/elitist" style="font-size: 20px">elitist </a><a href="/tag/evil" style="font-size: 19px">evil </a><a href="/tag/experiment" style="font-size: 15px">experiment </a><a href="/tag/extension" style="font-size: 20px">extension </a><a href="/tag/ExtJS" style="font-size: 20px">ExtJS </a><a href="/tag/fast" style="font-size: 20px">fast </a><a href="/tag/features" style="font-size: 15px">features </a><a href="/tag/firefox" style="font-size: 20px">firefox </a><a href="/tag/flash" style="font-size: 17px">flash </a><a href="/tag/format" style="font-size: 11px">format </a><a href="/tag/function" style="font-size: 13px">function </a><a href="/tag/future" style="font-size: 15px">future </a><a href="/tag/GAE" style="font-size: 13px">GAE </a><a href="/tag/github" style="font-size: 15px">github </a><a href="/tag/google" style="font-size: 20px">google </a><a href="/tag/google wave" style="font-size: 20px">google wave </a><a href="/tag/graphics" style="font-size: 17px">graphics </a><a href="/tag/hacking" style="font-size: 11px">hacking </a><a href="/tag/hardware" style="font-size: 11px">hardware </a><a href="/tag/history" style="font-size: 11px">history </a><a href="/tag/hosting" style="font-size: 19px">hosting </a><a href="/tag/html5" style="font-size: 19px">html5 </a><a href="/tag/idea" style="font-size: 13px">idea </a><a href="/tag/internet exploder" style="font-size: 20px">internet exploder </a><a href="/tag/ipad" style="font-size: 17px">ipad </a><a href="/tag/javascript" style="font-size: 20px">javascript </a><a href="/tag/json" style="font-size: 15px">json </a><a href="/tag/library" style="font-size: 11px">library </a><a href="/tag/lines" style="font-size: 13px">lines </a><a href="/tag/linux" style="font-size: 17px">linux </a><a href="/tag/login" style="font-size: 15px">login </a><a href="/tag/mac" style="font-size: 11px">mac </a><a href="/tag/magical" style="font-size: 15px">magical </a><a href="/tag/math" style="font-size: 11px">math </a><a href="/tag/meta" style="font-size: 13px">meta </a><a href="/tag/microsoft" style="font-size: 15px">microsoft </a><a href="/tag/microwave" style="font-size: 15px">microwave </a><a href="/tag/mp3" style="font-size: 11px">mp3 </a><a href="/tag/multitouch" style="font-size: 13px">multitouch </a><a href="/tag/new" style="font-size: 19px">new </a><a href="/tag/nostalgia" style="font-size: 11px">nostalgia </a><a href="/tag/ocr" style="font-size: 13px">ocr </a><a href="/tag/offline" style="font-size: 17px">offline </a><a href="/tag/old" style="font-size: 17px">old </a><a href="/tag/onlypaths" style="font-size: 17px">onlypaths </a><a href="/tag/pi" style="font-size: 19px">pi </a><a href="/tag/player" style="font-size: 11px">player </a><a href="/tag/progress" style="font-size: 11px">progress </a><a href="/tag/prototype" style="font-size: 13px">prototype </a><a href="/tag/python" style="font-size: 20px">python </a><a href="/tag/raphael" style="font-size: 19px">raphael </a><a href="/tag/release" style="font-size: 13px">release </a><a href="/tag/rewrite" style="font-size: 13px">rewrite </a><a href="/tag/school" style="font-size: 15px">school </a><a href="/tag/security" style="font-size: 15px">security </a><a href="/tag/shiny" style="font-size: 20px">shiny </a><a href="/tag/ShinyTouch" style="font-size: 13px">ShinyTouch </a><a href="/tag/simple" style="font-size: 11px">simple </a><a href="/tag/site" style="font-size: 13px">site </a><a href="/tag/small" style="font-size: 20px">small </a><a href="/tag/speed" style="font-size: 11px">speed </a><a href="/tag/SVG" style="font-size: 15px">SVG </a><a href="/tag/touch" style="font-size: 13px">touch </a><a href="/tag/update" style="font-size: 20px">update </a><a href="/tag/upload" style="font-size: 17px">upload </a><a href="/tag/user interface" style="font-size: 11px">user interface </a><a href="/tag/vector" style="font-size: 13px">vector </a><a href="/tag/vectoreditor" style="font-size: 19px">vectoreditor </a><a href="/tag/version" style="font-size: 13px">version </a><a href="/tag/video" style="font-size: 15px">video </a><a href="/tag/vision" style="font-size: 11px">vision </a><a href="/tag/vp8" style="font-size: 11px">vp8 </a><a href="/tag/vX JS" style="font-size: 19px">vX JS </a><a href="/tag/wave" style="font-size: 20px">wave </a><a href="/tag/wikify" style="font-size: 20px">wikify </a><a href="/tag/wikipedia" style="font-size: 17px">wikipedia </a><a href="/tag/wordpress" style="font-size: 20px">wordpress </a>
          </div>
        </div>
        <div id="content">
          <h1>
            December 
            2015<span class="thin"> Archive</span>
          </h1>
          <article class="article intro">
            <header>
              <h2><a href="/2015/12/recovering-deleted-data-from-leveldb/">Recovering Deleted Data from LevelDB</a> <span class="subtitle">02 December 2015</span></h2>
            </header>
            <section class="content"><p><div class="pic md right" style="width: 300px" ><img alt=""  src="/articles/2015/LevelDB%20Recovery/hex-medium.jpg" ></div></p>
<p>It was 4am this morning, and I did something stupid. I was trying to write something which would automatically delete all empty documents. Within a few seconds of running it, all my precious data was gone.&nbsp;Oops.</p>
<p>There’s probably some grander lesson to be learned about keeping routine backups and not being an idiot. But the strength of that parable is somewhat weakened because I did manage to get the data&nbsp;back. </p>
<h2 id="how-leveldb-works">How LevelDB&nbsp;Works</h2>
<p><a href="http://leveldb.org/">LevelDB</a>, developed by Sanjay Ghemawat and Jeff Dean of Google, is a fast key-value store based on a <a href="http://paperhub.s3.amazonaws.com/18e91eb4db2114a06ea614f0384f2784.pdf">log-structured merge tree</a>. </p>
<p>It’s not a relational database. It can’t do complex <span class="caps">SQL</span> queries. In fact, the only type of query that one can do is to ask for the set of entries whose keys fit lexicographically in some range. Think of it as a list of entities perpetually sorted by a key, where you can quickly read out any entry (or contiguous range) with a simple <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a>. </p>
<p>It’s not just a metaphor— the basic primitive underlying LevelDB is literally called an SSTable (Sorted String Table). If you have a big arbitrarily large sorted list, the task of locating any single entity in a sorted list can be done in O(log n) time, which is nice because hopping around the big spinning metal hard disk platter is glacially slow in computer&nbsp;time. </p>
<!-- What's worse— inserting some new entry or deleting an old one may involve rewriting the whole file! -->

<p>In <span class="caps">RAM</span>, hopping around is pretty fast. It’s part of the name— Random Access Memory. In RAM you can maintain a balanced <a href="https://en.wikipedia.org/wiki/Binary_search_tree">binary search tree</a>, so that you can search, insert, delete, or update the contents of any entry in O(log n) time— all while keeping the contents&nbsp;sorted. </p>
<p>Computers tend to have a limited amount of <span class="caps">RAM</span> compared to hard disk space, so most databases have to somehow deal with both beasts. To a certain extent, LevelDB plays to the strengths of each while using the other to fill in&nbsp;weaknesses. </p>
<p><div class="pic md" style="" ><img alt=""  src="/articles/2015/LevelDB%20Recovery/sstable-igvita.png" ><div class="caption">Diagram taken from https://www.igvita.com/2012/02/06/sstable-and-log-structured-storage-leveldb/</div></div>  </p>
<p>To add some entry to the key-value store, LevelDB first sticks it into <span class="caps">RAM</span>— in particular some sort of data structure that keeps everything all nice and sorted. But over time, this chunk of memory may grow uncomfortably large, at which point its sorted contents get flushed into a file, and the old chunk of memory is emptied and ready for new&nbsp;data. </p>
<p>Once data is saved to the disk, the saved SSTables are essentially treated as immutable. Otherwise, if you want to keep the data sorted you might have to rewrite the entire file whenever a new entry is added, or an old one is deleted. This immutability property is really what ends up saving me, because it means that in spite of deleting everything— nothing is ever truly&nbsp;lost. </p>
<p>To look up some range of entries, LevelDB first checks <span class="caps">RAM</span> in case something matching the query has been manipulated recently. Then it checks the little immutable chunks which have already been flushed to disk, and merges them all together quickly in a manner similar to <a href="https://en.wikipedia.org/wiki/Merge_sort">merge sort</a>. </p>
<p>There’s some more to it which I haven’t covered, such as an append-only log to aid recovery in the event of some catastrophic power failure or software crash, and the process by which older SSTables get compacted together. But this essentially represents the basic design of an <span class="caps">LSM</span> database, at least enough to understand the principle of recovering deleted&nbsp;files. </p>
<h2 id="leveldb-structure">LevelDB&nbsp;Structure</h2>
<p><div class="pic md right" style="width: 200px" ><img alt=""  src="/articles/2015/LevelDB%20Recovery/files-medium.jpg" ></div></p>
<p>When you save some stuff to a LevelDB database, what you find is actually a directory consisting of a couple of <code>.log</code> files, <code>.ldb</code> files, <code>MANIFEST</code>, <code>CURRENT</code>, <code>LOG</code> and <code>LOCK</code>. As far as I’m aware the log files are temporary and kept in case the database is interrupted before it has an opportunity to write things down into a sorted table. Thus I’ll pretend that after having cleanly exited the database (following accidentally deleting lots of stuff), all the content which might possibly be interesting is within the <code>.ldb</code> files. </p>
<p>If you try to open up an <code>.ldb</code> in a hex editor, you’ll notice bits which look tantalizingly like the data you might want to recover, albeit subtly mangled by the Snappy compression&nbsp;algorithm. </p>
<h2 id="recovery">Recovery</h2>
<p>While you might imagine that being able to access previous versions of the data would be a natural and obvious affordance for a log-structured immutable append-only key-value store, I couldn’t find any APIs for accessing deleted&nbsp;data. </p>
<p>A good first step might be figuring out some way to parse those <code>.ldb</code> files. Fortunately, it’s <a href="https://leveldb.googlecode.com/svn/trunk/doc/table_format.txt">well-documented enough</a> that there are actually <a href="https://github.com/golang/leveldb/blob/master/table/table.go">third-party implementations</a>. And from the looks of it’s actually pretty&nbsp;simple.</p>
<p>That golang leveldb repo is particularly cool because it includes a helper tool <code>ldbdump</code> which reads in an <code>.ldb</code> file and dumps its contents. In fact the whole process of using it was surprisingly rather painless. I just ran <code>go get github.com/golang/leveldb</code>, navigated to the <code>cmd/ldbdump</code> directory and ran <code>go build -o ldbdump main.go</code>. I then wrote a little Python script which would call that program for all the <code>.ldb</code> files in a particular directory and parse it into a more canonical <span class="caps">JSON</span>&nbsp;form. </p>
<pre><code><span style='display:none' detected-language='processing'></span>base = <span class="hljs-string">"test-stuff copy"</span>

<span class="hljs-keyword">import</span> os
from subprocess <span class="hljs-keyword">import</span> Popen, <span class="caps">PIPE</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> ast
<span class="hljs-keyword">for</span> f in os.listdir(base):
  <span class="hljs-keyword">if</span> f.endswith(<span class="hljs-string">".ldb"</span>):
    process = Popen([<span class="hljs-string">"ldbdump"</span>, os.path.<span class="hljs-built_in">join</span>(base, f)], stdout=<span class="caps">PIPE</span>)
    (output, err) = process.communicate()
    exit_code = process.wait()
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">line</span> in (output.<span class="hljs-built_in">split</span>(<span class="hljs-string">"\n"</span>)[<span class="hljs-number">1</span>:]):
      <span class="hljs-keyword">if</span> <span class="hljs-built_in">line</span>.strip() == <span class="hljs-string">""</span>: <span class="hljs-keyword">continue</span>
      parsed = ast.literal_eval(<span class="hljs-string">"{"</span> + <span class="hljs-built_in">line</span> + <span class="hljs-string">"}"</span>)
      <span class="hljs-variable">key</span> = parsed.keys()[<span class="hljs-number">0</span>]
      <span class="hljs-built_in">print</span> json.dumps({ <span class="hljs-string">"key"</span>: <span class="hljs-variable">key</span>.encode(<span class="hljs-string">'string-escape'</span>), <span class="hljs-string">"value"</span>: parsed[<span class="hljs-variable">key</span>] })
</code></pre><p>Out of this I got a <span class="caps">73MB</span> JSON file, which seemed to have all the contents in some form but unfortunately ordered by the key. This is bad because it conflates different versions of a particular key— an object may have been changed, deleted, and created&nbsp;again.  </p>
<pre><code><span style='display:none' detected-language='tex'></span><span class="hljs-special">{</span>"value": "<span class="hljs-special">{</span><span class="hljs-command">\"</span>id<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Whole Earth Catalog<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>type<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>text<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>parent<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>__root__<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>created<span class="hljs-command">\"</span>:1447821578094,<span class="hljs-command">\"</span>list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-command">\"</span><span class="caps">MI11NZ</span><span class="hljs-command">\"</span><span class="hljs-special">]</span><span class="hljs-special">}</span>", "key": "!entities/aleph!Whole Earth Catalog<span class="hljs-command">\\</span>x01RI<span class="hljs-command">\\</span>x05<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00"<span class="hljs-special">}</span>
<span class="hljs-special">{</span>"value": "<span class="hljs-special">{</span><span class="hljs-command">\"</span>id<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Wikia<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>type<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>text<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>parent<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>__root__<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>created<span class="hljs-command">\"</span>:1447821578094,<span class="hljs-command">\"</span>list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-command">\"</span><span class="caps">XB8UAU</span><span class="hljs-command">\"</span><span class="hljs-special">]</span><span class="hljs-special">}</span>", "key": "!entities/aleph!Wikia<span class="hljs-command">\\</span>x01UI<span class="hljs-command">\\</span>x05<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00"<span class="hljs-special">}</span>
<span class="hljs-special">{</span>"value": "<span class="hljs-special">{</span><span class="hljs-command">\"</span>id<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Will Ferrell<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>type<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>text<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>parent<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>__root__<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>created<span class="hljs-command">\"</span>:1447841260204,<span class="hljs-command">\"</span>list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-command">\"</span><span class="caps">AKVVBF</span><span class="hljs-command">\"</span><span class="hljs-special">]</span><span class="hljs-special">}</span>", "key": "!entities/aleph!Will Ferrell<span class="hljs-command">\\</span>x01=N<span class="hljs-command">\\</span>x05<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00<span class="hljs-command">\\</span>x00"<span class="hljs-special">}</span>
</code></pre><p>One curious thing I noticed was the presence of some strange binary digits after the end of each key. After a little bit of experimentation it turns out that if you convert that binary string into a number, and sort the entire database by it, sticks all the changes in the proper chronological&nbsp;order!</p>
<pre><code><span style='display:none' detected-language='processing'></span><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> ast 
<span class="hljs-keyword">import</span> binascii

things = []
<span class="hljs-keyword">for</span> <span class="hljs-built_in">line</span> in sys.stdin:
  obj = json.loads(<span class="hljs-built_in">line</span>)
  halves = obj[<span class="hljs-string">'key'</span>].<span class="hljs-built_in">split</span>(<span class="hljs-string">"\\x"</span>, <span class="hljs-number">1</span>)
  <span class="hljs-variable">key</span> = ast.literal_eval(<span class="hljs-string">"'\\x"</span> + halves[<span class="hljs-number">1</span>].replace(<span class="hljs-string">"\\\\u00"</span>, <span class="hljs-string">"\\x"</span>) + <span class="hljs-string">"'"</span>)
  <span class="hljs-keyword">if</span> len(<span class="hljs-variable">key</span>) == <span class="hljs-number">8</span>:
    time = <span class="hljs-built_in">int</span>(binascii.hexlify(<span class="hljs-variable">key</span>[<span class="hljs-number">1</span>:][::-<span class="hljs-number">1</span>]), <span class="hljs-number">16</span>)
    things.<span class="hljs-built_in">append</span>((time, halves[<span class="hljs-number">0</span>], obj[<span class="hljs-string">'value'</span>]))

<span class="hljs-keyword">for</span> x in sorted(things, <span class="hljs-variable">key</span> = lambda k: k[<span class="hljs-number">0</span>]):
  <span class="hljs-built_in">print</span> json.dumps(x)
</code></pre><p>And my precious data is now saved! Or well, rather, it always was— but now I finally have access to it in some reasonable&nbsp;form. </p>
<p>I could see the first few entries, which happened to be some particularly fecal test&nbsp;data</p>
<pre><code><span style='display:none' detected-language='json'></span>[<span class="hljs-number">1</span>, <span class="hljs-string">"!changes/wumbo/!00000001448849217216"</span>, <span class="hljs-string">"poop"</span>]
[<span class="hljs-number">2</span>, <span class="hljs-string">"!entities/wumbo/!00000001448849471307"</span>, <span class="hljs-string">"poop"</span>]
[<span class="hljs-number">3</span>, <span class="hljs-string">"!changes/wumbo/!00000001448849471308"</span>, <span class="hljs-string">"poop"</span>]
</code></pre><p>Then some data in the middle with an imported movie&nbsp;database</p>
<pre><code><span style='display:none' detected-language='json'></span>[<span class="hljs-number">2435</span>, <span class="hljs-string">"!changes/merp!000000014488557172160000001163"</span>, <span class="hljs-string">"Deja Vu"</span>]
[<span class="hljs-number">2437</span>, <span class="hljs-string">"!changes/merp!000000014488557172160000001164"</span>, <span class="hljs-string">"Gattaca"</span>]
[<span class="hljs-number">2439</span>, <span class="hljs-string">"!changes/merp!000000014488557172170000001165"</span>, <span class="hljs-string">"Sunshine"</span>]
</code></pre><p>And of course, the part of it where I accidentally deleted&nbsp;everything</p>
<pre><code><span style='display:none' detected-language='json'></span>[<span class="hljs-number">394061</span>, <span class="hljs-string">"!entities/aleph!<span class="caps">OYHEDW</span>"</span>, <span class="hljs-string">""</span>]
[<span class="hljs-number">394062</span>, <span class="hljs-string">"!entities/aleph!Gerry Sussman"</span>, <span class="hljs-string">""</span>]
[<span class="hljs-number">394063</span>, <span class="hljs-string">"!entities/aleph!<span class="caps">VSPKP8</span>"</span>, <span class="hljs-string">""</span>]
</code></pre><p>So I guess that’s it! In case you ever get stuck in a rut where you’ve unwittingly deleted the contents of your LevelDB and forgot to keep decent backups, and you’re lucky enough that the changes haven’t been compactified yet, you can possibly get your data&nbsp;back. </p>
<!-- 
There was a bit of a puzzle left, which was whether or not it was a timestamp. The first entry in the database was pretty small— just 78,128. I assumed that the epoch was set at the creation of the database, and from then kept counting. At the end of the file, that prefix number grew quite substantially to an 11 digit number.

    [78128, "!changes/wumbo/!00000001448849217216", "poop"]
    ...
    [26339520816, "!entities/aleph!@WZ1Y8ZF6F7594YEM$", "{\"type\":\"text\",\"id\":\"@WZ1Y8ZF6F7594YEM$\",\"text\":\"Scratchpad 1\",\"parent\":\"2 December 2015\",\"created\":1449050780995,\"list\":[]}"]

I had a few entries in the database that were actually tagged with timestamps, so I figured why not try to plot them against each other to see if there was a linear correspondence. 

![](plotly.png)

So it definitely didn't correspond linearly to a UNIX timestamp, but it did happen to look a lot like my own usage of the database. I had a big import at some point, and sort of slow, peaky interactions since then. I was also little curious what the spacing was. It turns out that each each one was exactly 131,072 apart from each other (which is kind of odd, because counters tend to go in increments of, well, one). A friend noticed 131,072 was 2^17, and so I . 
 -->



<pre><code><span style='display:none' detected-language='x86asm'></span><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">57</span> <span class="caps">FB</span> <span class="hljs-number">80</span> 8B <span class="hljs-number">24</span> <span class="hljs-number">75</span> <span class="hljs-number">47</span> <span class="hljs-pseudo"><span class="caps">DB</span></span>
</code></pre>
            </section>
          </article>
          <hr>
          <div class="nav"><a href="/archive" class="newer">« Archives</a><a href="/page/1" class="next">Latest Posts »</a></div>
        </div>
      </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-1367972-3', 'auto');
      ga('send', 'pageview');
      
    </script>
    <script>
      function squish(){
        document.getElementById("squishfoot").className += "squish"
      }
    </script>
    <style>
      .squish { font-size: 9px }
      .squishsquish { font-size: 8px }
      .squishsquishsquish { font-size: 7px }
      .squishsquishsquishsquish { font-size: 6px }
      .squishsquishsquishsquishsquish { font-size: 5px }
      .squishsquishsquishsquishsquishsquish { font-size: 4px }
      .squishsquishsquishsquishsquishsquishsquish { visibility: hidden }
    </style>
    <div class="graybar bottom">
      <footer>
        <div id="squishfoot">I'm a tiny footer, please don't <a href="javascript:squish()">squish</a> me</div>
      </footer>
    </div>
  </body>
</html>